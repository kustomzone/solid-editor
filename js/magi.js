"undefined"==typeof Magi&&(Magi={}),Magi.Stats||(Magi.Stats={vec2CreateCount:0,vec3CreateCount:0,vec4CreateCount:0,mat3CreateCount:0,mat4CreateCount:0,quat4CreateCount:0}),"undefined"!=typeof Float32Array?glMatrixArrayType=Float32Array:glMatrixArrayType=Array;var vec3=function(){return vec3.create.apply(vec3,arguments)};vec3.create=function(t,e,i){var r=new glMatrixArrayType(3);return Magi.Stats.vec3CreateCount++,null!=e?(r[0]=t,r[1]=e,r[2]=i):t&&(r[0]=t[0],r[1]=t[1],r[2]=t[2]),r},vec4=function(){return vec4.create.apply(vec4,arguments)},vec4.create=function(t,e,i,r){var a=new glMatrixArrayType(4);return Magi.Stats.vec4CreateCount++,null!=e?(a[0]=t,a[1]=e,a[2]=i,a[3]=r):t&&(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]),a},vec4.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},vec4.setLeft=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},vec2=function(){return vec2.create.apply(vec2,arguments)},vec2.create=function(t,e){var i=new glMatrixArrayType(2);return Magi.Stats.vec2CreateCount++,null!=e?(i[0]=t,i[1]=e):t&&(i[0]=t[0],i[1]=t[1]),i},vec2.set=function(t,e){return e[0]=t[0],e[1]=t[1],e},vec2.setLeft=function(t,e){return t[0]=e[0],t[1]=e[1],t},vec3.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},vec3.setLeft=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},vec3.set3=function(t,e){return e[0]=e[1]=e[2]=t,e},vec3.add=function(t,e,i){return i&&t!=i?(i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i):(t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t)},vec3.subtract=function(t,e,i){return i&&t!=i?(i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i):(t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t)},vec3.sub=vec3.subtract,vec3.negate=function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},vec3.scale=function(t,e,i){return i&&t!=i?(i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i):(t[0]*=e,t[1]*=e,t[2]*=e,t)},vec3.multiply=function(t,e,i){return i&&t!=i?(i[0]=t[0]*e[0],i[1]=t[1]*e[1],i[2]=t[2]*e[2],i):(t[0]*=e[0],t[1]*=e[1],t[2]*=e[2],t)},vec3.mul=vec3.multiply,vec3.normalize=function(t,e){e||(e=t);var i=t[0],r=t[1],a=t[2],n=Math.sqrt(i*i+r*r+a*a);return n?1==n?(e[0]=i,e[1]=r,e[2]=a,e):(n=1/n,e[0]=i*n,e[1]=r*n,e[2]=a*n,e):(e[0]=0,e[1]=0,e[2]=0,e)},vec3.cross=function(t,e,i){i||(i=t);var r=t[0],a=t[1],n=t[2],s=e[0],o=e[1],h=e[2];return i[0]=a*h-n*o,i[1]=n*s-r*h,i[2]=r*o-a*s,i},vec3.radius=function(t){var e=t[0],i=t[1],r=t[2];return Math.sqrt(e*e+i*i+r*r)},vec3.lengthSquare=function(t){var e=t[0],i=t[1],r=t[2];return e*e+i*i+r*r},vec3.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},vec3.direction=function(t,e,i){i||(i=t);var r=t[0]-e[0],a=t[1]-e[1],n=t[2]-e[2],s=Math.sqrt(r*r+a*a+n*n);return s?(s=1/s,i[0]=r*s,i[1]=a*s,i[2]=n*s,i):(i[0]=0,i[1]=0,i[2]=0,i)},vec3.distance=function(t,e){var i=t[0]-e[0],r=t[1]-e[1],a=t[2]-e[2];return Math.sqrt(i*i+r*r+a*a)},vec3.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+"]"};var mat3=function(t){return null==t?mat3.identity():mat3.create.apply(mat3,arguments)};mat3.create=function(t){var e=new glMatrixArrayType(9);return Magi.Stats.mat3CreateCount++,t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9]),e},mat3.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},mat3.identity=function(t){return null==t&&(t=mat3.create()),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},mat3.toMat4=function(t,e){return e||(e=mat4.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},mat3.transpose=function(t,e){if(!e||t==e){var i=t[1],r=t[2],a=t[5];return t[1]=t[3],t[2]=t[6],t[5]=t[7],t[3]=i,t[6]=r,t[7]=a,t}return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e},mat3.multiplyVec3=function(t,e,i){i||(i=e);var r=e[0],a=e[1],n=e[2];return i[0]=t[0]*r+t[3]*a+t[6]*n,i[1]=t[1]*r+t[4]*a+t[7]*n,i[2]=t[2]*r+t[5]*a+t[8]*n,i},mat3.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+"]"};var mat4=function(t){return null==t?mat4.identity():mat4.create.apply(mat4,arguments)};mat4.create=function(t){var e=new glMatrixArrayType(16);return Magi.Stats.mat4CreateCount++,t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e},mat4.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},mat4.identity=function(t){return null==t&&(t=mat4.create()),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},mat4.transpose=function(t,e){if(!e||t==e){var i=t[1],r=t[2],a=t[3],n=t[6],s=t[7],o=t[11];return t[1]=t[4],t[2]=t[8],t[3]=t[12],t[4]=i,t[6]=t[9],t[7]=t[13],t[8]=r,t[9]=n,t[11]=t[14],t[12]=a,t[13]=s,t[14]=o,t}return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},mat4.determinant=function(t){var e=t[0],i=t[1],r=t[2],a=t[3],n=t[4],s=t[5],o=t[6],h=t[7],l=t[8],u=t[9],c=t[10],f=t[11],d=t[12],g=t[13],m=t[14],p=t[15];return d*u*o*a-l*g*o*a-d*s*c*a+n*g*c*a+l*s*m*a-n*u*m*a-d*u*r*h+l*g*r*h+d*i*c*h-e*g*c*h-l*i*m*h+e*u*m*h+d*s*r*f-n*g*r*f-d*i*o*f+e*g*o*f+n*i*m*f-e*s*m*f-l*s*r*p+n*u*r*p+l*i*o*p-e*u*o*p-n*i*c*p+e*s*c*p},mat4.inverse=function(t,e){e||(e=t);var i=t[0],r=t[1],a=t[2],n=t[3],s=t[4],o=t[5],h=t[6],l=t[7],u=t[8],c=t[9],f=t[10],d=t[11],g=t[12],m=t[13],p=t[14],v=t[15],M=i*o-r*s,x=i*h-a*s,y=i*l-n*s,b=r*h-a*o,T=r*l-n*o,E=a*l-n*h,w=u*m-c*g,C=u*p-f*g,A=u*v-d*g,S=c*p-f*m,F=c*v-d*m,N=f*v-d*p,L=1/(M*N-x*F+y*S+b*A-T*C+E*w);return e[0]=(o*N-h*F+l*S)*L,e[1]=(-r*N+a*F-n*S)*L,e[2]=(m*E-p*T+v*b)*L,e[3]=(-c*E+f*T-d*b)*L,e[4]=(-s*N+h*A-l*C)*L,e[5]=(i*N-a*A+n*C)*L,e[6]=(-g*E+p*y-v*x)*L,e[7]=(u*E-f*y+d*x)*L,e[8]=(s*F-o*A+l*w)*L,e[9]=(-i*F+r*A-n*w)*L,e[10]=(g*T-m*y+v*M)*L,e[11]=(-u*T+c*y-d*M)*L,e[12]=(-s*S+o*C-h*w)*L,e[13]=(i*S-r*C+a*w)*L,e[14]=(-g*b+m*x-p*M)*L,e[15]=(u*b-c*x+f*M)*L,e},mat4.toRotationMat=function(t,e){return e||(e=mat4.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},mat4.toMat3=function(t,e){return e||(e=mat3.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},mat4.toInverseMat3=function(t,e){var i=t[0],r=t[1],a=t[2],n=t[4],s=t[5],o=t[6],h=t[8],l=t[9],u=t[10],c=u*s-o*l,f=-u*n+o*h,d=l*n-s*h,g=i*c+r*f+a*d;if(!g)return null;var m=1/g;return e||(e=mat3.create()),e[0]=c*m,e[1]=(-u*r+a*l)*m,e[2]=(o*r-a*s)*m,e[3]=f*m,e[4]=(u*i-a*h)*m,e[5]=(-o*i+a*n)*m,e[6]=d*m,e[7]=(-l*i+r*h)*m,e[8]=(s*i-r*n)*m,e},mat4.multiply=function(t,e,i){i||(i=t);var r=t[0],a=t[1],n=t[2],s=t[3],o=t[4],h=t[5],l=t[6],u=t[7],c=t[8],f=t[9],d=t[10],g=t[11],m=t[12],p=t[13],v=t[14],M=t[15],x=e[0],y=e[1],b=e[2],T=e[3],E=e[4],w=e[5],C=e[6],A=e[7],S=e[8],F=e[9],N=e[10],L=e[11],_=e[12],D=e[13],R=e[14],O=e[15];return i[0]=x*r+y*o+b*c+T*m,i[1]=x*a+y*h+b*f+T*p,i[2]=x*n+y*l+b*d+T*v,i[3]=x*s+y*u+b*g+T*M,i[4]=E*r+w*o+C*c+A*m,i[5]=E*a+w*h+C*f+A*p,i[6]=E*n+w*l+C*d+A*v,i[7]=E*s+w*u+C*g+A*M,i[8]=S*r+F*o+N*c+L*m,i[9]=S*a+F*h+N*f+L*p,i[10]=S*n+F*l+N*d+L*v,i[11]=S*s+F*u+N*g+L*M,i[12]=_*r+D*o+R*c+O*m,i[13]=_*a+D*h+R*f+O*p,i[14]=_*n+D*l+R*d+O*v,i[15]=_*s+D*u+R*g+O*M,i},mat4.multiplyVec3=function(t,e,i){i||(i=e);var r=e[0],a=e[1],n=e[2];return i[0]=t[0]*r+t[4]*a+t[8]*n+t[12],i[1]=t[1]*r+t[5]*a+t[9]*n+t[13],i[2]=t[2]*r+t[6]*a+t[10]*n+t[14],i},mat4.multiplyVec4=function(t,e,i){i||(i=e);var r=e[0],a=e[1],n=e[2],s=e[3];return i[0]=t[0]*r+t[4]*a+t[8]*n+t[12]*s,i[1]=t[1]*r+t[5]*a+t[9]*n+t[13]*s,i[2]=t[2]*r+t[6]*a+t[10]*n+t[14]*s,i[3]=t[3]*r+t[7]*a+t[11]*n+t[15]*s,i},mat4.translate=function(t,e,i){var r=e[0],a=e[1],n=e[2];if(!i||t==i)return t[12]=t[0]*r+t[4]*a+t[8]*n+t[12],t[13]=t[1]*r+t[5]*a+t[9]*n+t[13],t[14]=t[2]*r+t[6]*a+t[10]*n+t[14],t[15]=t[3]*r+t[7]*a+t[11]*n+t[15],t;var s=t[0],o=t[1],h=t[2],l=t[3],u=t[4],c=t[5],f=t[6],d=t[7],g=t[8],m=t[9],p=t[10],v=t[11];return i[0]=s,i[1]=o,i[2]=h,i[3]=l,i[4]=u,i[5]=c,i[6]=f,i[7]=d,i[8]=g,i[9]=m,i[10]=p,i[11]=v,i[12]=s*r+u*a+g*n+t[12],i[13]=o*r+c*a+m*n+t[13],i[14]=h*r+f*a+p*n+t[14],i[15]=l*r+d*a+v*n+t[15],i},mat4.scale=function(t,e,i){var r=e[0],a=e[1],n=e[2];return i&&t!==i?(i[0]=t[0]*r,i[1]=t[1]*r,i[2]=t[2]*r,i[3]=t[3]*r,i[4]=t[4]*a,i[5]=t[5]*a,i[6]=t[6]*a,i[7]=t[7]*a,i[8]=t[8]*n,i[9]=t[9]*n,i[10]=t[10]*n,i[11]=t[11]*n,i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i):(t[0]*=r,t[1]*=r,t[2]*=r,t[3]*=r,t[4]*=a,t[5]*=a,t[6]*=a,t[7]*=a,t[8]*=n,t[9]*=n,t[10]*=n,t[11]*=n,t)},mat4.billboard=function(t,e){var i=t[0],r=t[5],a=t[10];a*=a;var n=(i*=i)>(r*=r)?i:r;return n=n>a?n:a,n=Math.sqrt(n),e&&t!==e?(e[0]=n,e[1]=0,e[2]=0,e[3]=t[3],e[4]=0,e[5]=n,e[6]=0,e[7]=t[7],e[8]=0,e[9]=0,e[10]=n,e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e):(t[0]=n,t[1]=0,t[2]=0,t[4]=0,t[5]=n,t[6]=0,t[8]=0,t[9]=0,t[10]=n,t)},mat4.rotate=function(t,e,i,r){var a=i[0],n=i[1],s=i[2],o=Math.sqrt(a*a+n*n+s*s);if(!o)return null;1!=o&&(a*=o=1/o,n*=o,s*=o);var h=Math.sin(e),l=Math.cos(e),u=1-l,c=t[0],f=t[1],d=t[2],g=t[3],m=t[4],p=t[5],v=t[6],M=t[7],x=t[8],y=t[9],b=t[10],T=t[11],E=a*a*u+l,w=n*a*u+s*h,C=s*a*u-n*h,A=a*n*u-s*h,S=n*n*u+l,F=s*n*u+a*h,N=a*s*u+n*h,L=n*s*u-a*h,_=s*s*u+l;return r?t!=r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]):r=t,r[0]=c*E+m*w+x*C,r[1]=f*E+p*w+y*C,r[2]=d*E+v*w+b*C,r[3]=g*E+M*w+T*C,r[4]=c*A+m*S+x*F,r[5]=f*A+p*S+y*F,r[6]=d*A+v*S+b*F,r[7]=g*A+M*S+T*F,r[8]=c*N+m*L+x*_,r[9]=f*N+p*L+y*_,r[10]=d*N+v*L+b*_,r[11]=g*N+M*L+T*_,r},mat4.rotateX=function(t,e,i){var r=Math.sin(e),a=Math.cos(e),n=t[4],s=t[5],o=t[6],h=t[7],l=t[8],u=t[9],c=t[10],f=t[11];return i?t!=i&&(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[4]=n*a+l*r,i[5]=s*a+u*r,i[6]=o*a+c*r,i[7]=h*a+f*r,i[8]=n*-r+l*a,i[9]=s*-r+u*a,i[10]=o*-r+c*a,i[11]=h*-r+f*a,i},mat4.rotateY=function(t,e,i){var r=Math.sin(e),a=Math.cos(e),n=t[0],s=t[1],o=t[2],h=t[3],l=t[8],u=t[9],c=t[10],f=t[11];return i?t!=i&&(i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=n*a+l*-r,i[1]=s*a+u*-r,i[2]=o*a+c*-r,i[3]=h*a+f*-r,i[8]=n*r+l*a,i[9]=s*r+u*a,i[10]=o*r+c*a,i[11]=h*r+f*a,i},mat4.rotateZ=function(t,e,i){var r=Math.sin(e),a=Math.cos(e),n=t[0],s=t[1],o=t[2],h=t[3],l=t[4],u=t[5],c=t[6],f=t[7];return i?t!=i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=n*a+l*r,i[1]=s*a+u*r,i[2]=o*a+c*r,i[3]=h*a+f*r,i[4]=n*-r+l*a,i[5]=s*-r+u*a,i[6]=o*-r+c*a,i[7]=h*-r+f*a,i},mat4.frustum=function(t,e,i,r,a,n,s){s||(s=mat4.create());var o=e-t,h=r-i,l=n-a;return s[0]=2*a/o,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2*a/h,s[6]=0,s[7]=0,s[8]=(e+t)/o,s[9]=(r+i)/h,s[10]=-(n+a)/l,s[11]=-1,s[12]=0,s[13]=0,s[14]=-n*a*2/l,s[15]=0,s},mat4.perspective=function(t,e,i,r,a){var n=i*Math.tan(t*Math.PI/360),s=n*e;return mat4.frustum(-s,s,-n,n,i,r,a)},mat4.ortho=function(t,e,i,r,a,n,s){s||(s=mat4.create());var o=e-t,h=r-i,l=n-a;return s[0]=2/o,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2/h,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=-2/l,s[11]=0,s[12]=-(t+e)/o,s[13]=-(r+i)/h,s[14]=-(n+a)/l,s[15]=1,s},mat4.lookAt=function(t,e,i,r){r||(r=mat4.create());var a,n,s,o,h,l,u,c,f,d,g=t[0],m=t[1],p=t[2],v=i[0],M=i[1],x=i[2],y=e[0],b=e[1],T=e[2];return g==y&&m==b&&p==T?mat4.identity(r):(a=g-e[0],n=m-e[1],s=p-e[2],o=M*(s*=d=1/Math.sqrt(a*a+n*n+s*s))-x*(n*=d),h=x*(a*=d)-v*s,l=v*n-M*a,(d=Math.sqrt(o*o+h*h+l*l))?(o*=d=1/d,h*=d,l*=d):(o=0,h=0,l=0),u=n*l-s*h,c=s*o-a*l,f=a*h-n*o,(d=Math.sqrt(u*u+c*c+f*f))?(u*=d=1/d,c*=d,f*=d):(u=0,c=0,f=0),r[0]=o,r[1]=u,r[2]=a,r[3]=0,r[4]=h,r[5]=c,r[6]=n,r[7]=0,r[8]=l,r[9]=f,r[10]=s,r[11]=0,r[12]=-(o*g+h*m+l*p),r[13]=-(u*g+c*m+f*p),r[14]=-(a*g+n*m+s*p),r[15]=1,r)},mat4.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+"]"},quat4=function(){return quat4.create.apply(quat4,arguments)},quat4.create=function(t){var e=new glMatrixArrayType(4);return Magi.Stats.quat4CreateCount++,t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]),e},quat4.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},quat4.calculateW=function(t,e){var i=t[0],r=t[1],a=t[2];return e&&t!=e?(e[0]=i,e[1]=r,e[2]=a,e[3]=-Math.sqrt(Math.abs(1-i*i-r*r-a*a)),e):(t[3]=-Math.sqrt(Math.abs(1-i*i-r*r-a*a)),t)},quat4.inverse=function(t,e){return e&&t!=e?(e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e):(t[0]*=1,t[1]*=1,t[2]*=1,t)},quat4.length=function(t){var e=t[0],i=t[1],r=t[2],a=t[3];return Math.sqrt(e*e+i*i+r*r+a*a)},quat4.normalize=function(t,e){e||(e=t);var i=t[0],r=t[1],a=t[2],n=t[3],s=Math.sqrt(i*i+r*r+a*a+n*n);return 0==s?(e[0]=0,e[1]=0,e[2]=0,e[3]=0,e):(s=1/s,e[0]=i*s,e[1]=r*s,e[2]=a*s,e[3]=n*s,e)},quat4.multiply=function(t,e,i){i||(i=t);var r=t[0],a=t[1],n=t[2],s=t[3],o=e[0],h=e[1],l=e[2],u=e[3];return i[0]=r*u+s*o+a*l-n*h,i[1]=a*u+s*h+n*o-r*l,i[2]=n*u+s*l+r*h-a*o,i[3]=s*u-r*o-a*h-n*l,i},quat4.multiplyVec3=function(t,e,i){i||(i=e);var r=e[0],a=e[1],n=e[2],s=t[0],o=t[1],h=t[2],l=t[3],u=l*r+o*n-h*a,c=l*a+h*r-s*n,f=l*n+s*a-o*r,d=-s*r-o*a-h*n;return i[0]=u*l+d*-s+c*-h-f*-o,i[1]=c*l+d*-o+f*-s-u*-h,i[2]=f*l+d*-h+u*-o-c*-s,i},quat4.toMat3=function(t,e){e||(e=mat3.create());var i=t[0],r=t[1],a=t[2],n=t[3],s=i+i,o=r+r,h=a+a,l=i*s,u=i*o,c=i*h,f=r*o,d=r*h,g=a*h,m=n*s,p=n*o,v=n*h;return e[0]=1-(f+g),e[1]=u-v,e[2]=c+p,e[3]=u+v,e[4]=1-(l+g),e[5]=d-m,e[6]=c-p,e[7]=d+m,e[8]=1-(l+f),e},quat4.toMat4=function(t,e){e||(e=mat4.create());var i=t[0],r=t[1],a=t[2],n=t[3],s=i+i,o=r+r,h=a+a,l=i*s,u=i*o,c=i*h,f=r*o,d=r*h,g=a*h,m=n*s,p=n*o,v=n*h;return e[0]=1-(f+g),e[1]=u-v,e[2]=c+p,e[3]=0,e[4]=u+v,e[5]=1-(l+g),e[6]=d-m,e[7]=0,e[8]=c-p,e[9]=d+m,e[10]=1-(l+f),e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},quat4.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+"]"},"undefined"==typeof Magi&&(Magi={}),Magi.Stats={shaderBindCount:0,materialUpdateCount:0,uniformSetCount:0,textureSetCount:0,textureCreationCount:0,vertexAttribPointerCount:0,bindBufferCount:0,drawElementsCount:0,drawArraysCount:0,vec2CreateCount:0,vec3CreateCount:0,vec4CreateCount:0,mat3CreateCount:0,mat4CreateCount:0,quat4CreateCount:0,reset:function(){for(var t in this)"number"==typeof this[t]&&(this[t]=0)},print:function(t){t.textContent="Shader bind count: "+this.shaderBindCount+"\nMaterial update count: "+this.materialUpdateCount+"\nUniform set count: "+this.uniformSetCount+"\nTexture creation count: "+this.textureCreationCount+"\nTexture set count: "+this.textureSetCount+"\nVertexAttribPointer count: "+this.vertexAttribPointerCount+"\nBind buffer count: "+this.bindBufferCount+"\nDraw elements count: "+this.drawElementsCount+"\nDraw arrays count: "+this.drawArraysCount+"\nvec2 create count: "+this.vec2CreateCount+"\nvec3 create count: "+this.vec3CreateCount+"\nvec4 create count: "+this.vec4CreateCount+"\nmat3 create count: "+this.mat3CreateCount+"\nmat4 create count: "+this.mat4CreateCount+"\nquat4 create count: "+this.quat4CreateCount+"\n"}},window.toArray||(toArray=function(t){for(var e=new Array(t.length),i=0;i<t.length;i++)e[i]=t[i];return e}),Object.forceExtend=function(t,e){for(var i in e)try{t[i]=e[i]}catch(t){}return t},Object.extend||(Object.extend=Object.forceExtend),Klass=function(){var t=function(){this.initialize.apply(this,arguments)};t.ancestors=toArray(arguments),t.prototype={};for(var e=0;e<arguments.length;e++){var i=arguments[e];i.prototype?Object.extend(t.prototype,i.prototype):Object.extend(t.prototype,i)}return Object.extend(t,t.prototype),t},Magi.Curves={angularDistance:function(t,e){var i=2*Math.PI,r=(e-t)%i;return r>Math.PI&&(r-=i),r<-Math.PI&&(r+=i),r},linePoint:function(t,e,i,r){return r||(r=vec3.create()),r[0]=t[0]+(e[0]-t[0])*i,r[1]=t[1]+(e[1]-t[1])*i,r[2]=t[2]+(e[2]-t[2])*i,r},quadraticPoint:function(t,e,i,r,a){a||(a=vec3.create());var n=t[0]+(e[0]-t[0])*r,s=n+(e[0]+(i[0]-e[0])*r-n)*r,o=t[1]+(e[1]-t[1])*r,h=o+(e[1]+(i[1]-e[1])*r-o)*r,l=t[2]+(e[2]-t[2])*r,u=l+(e[2]+(i[2]-e[2])*r-l)*r;return a[0]=s,a[1]=h,a[2]=u,a},cubicPoint:function(t,e,i,r,a,n){n||(n=vec3.create());var s=3*t[0],o=3*e[0],h=3*i[0],l=3*t[1],u=3*e[1],c=3*i[1],f=3*t[2],d=3*e[2],g=3*i[2],m=t[0]+a*(o-s+a*(s-2*o+h+a*(o-t[0]-h+r[0]))),p=t[1]+a*(u-l+a*(l-2*u+c+a*(u-t[1]-c+r[1]))),v=t[2]+a*(d-f+a*(f-2*d+g+a*(d-t[2]-g+r[2])));return n[0]=m,n[1]=p,n[2]=v,n},linearValue:function(t,e,i){return t+(e-t)*i},quadraticValue:function(t,e,i,r){var a=t+(e-t)*r;return a+(e+(i-e)*r-a)*r},cubicValue:function(t,e,i,r,a){var n=3*t,s=3*e,o=3*i;return t+a*(s-n+a*(n-2*s+o+a*(s-t-o+r)))},catmullRomPoint:function(t,e,i,r,a,n){null==n&&(n=vec3.create());var s=((2-a)*a-1)*a*.5,o=.5*((3*a-5)*a*a+2),h=((-3*a+4)*a+1)*a*.5,l=(a-1)*a*a*.5,u=t[0]*s+e[0]*o+i[0]*h+r[0]*l,c=t[1]*s+e[1]*o+i[1]*h+r[1]*l,f=t[2]*s+e[2]*o+i[2]*h+r[2]*l;return n[0]=u,n[1]=c,n[2]=f,n},catmullRomVector:function(t,e,i,r,a,n){var s=.5*(i[0]-t[0]+2*a*(2*t[0]-5*e[0]+4*i[0]-r[0])+3*a*a*(3*e[0]+r[0]-t[0]-3*i[0])),o=.5*(i[1]-t[1]+2*a*(2*t[1]-5*e[1]+4*i[1]-r[1])+3*a*a*(3*e[1]+r[1]-t[1]-3*i[1])),h=.5*(i[2]-t[2]+2*a*(2*t[2]-5*e[2]+4*i[2]-r[2])+3*a*a*(3*e[2]+r[2]-t[2]-3*i[2]));return n||(n=vec3.create()),n[0]=s,n[1]=o,n[2]=h,vec3.normalize(n),n},catmullRomPointVector:function(t,e,i,r,a,n){return null==n&&(n={point:vec3.create(),vector:vec3.create()}),this.catmullRomPoint(t,e,i,r,a,n.point),this.catmullRomVector(t,e,i,r,a,n.vector),n},lineVector:function(t,e,i){return null==i&&(i=vec3.create()),vec3.sub(e,t,i),i.normalize(),i},linePointVector:function(t,e,i,r){return null==r&&(r={point:vec3.create(),vector:vec3.create()}),this.linePoint(t,e,i,r.point),this.lineVector(t,e,r.vector),r},__tmp0:vec3.create(),__tmp1:vec3.create(),__tmp2:vec3.create(),__tmp3:vec3.create(),__tmp4:vec3.create(),__tmp5:vec3.create(),quadraticVector:function(t,e,i,r,a){null==a&&(a=vec3.create());var n=this.__tmp0,s=this.__tmp1;return n=this.linePoint(t,e,r,n),s=this.linePoint(e,i,r,s),this.lineVector(n,s,a)},quadraticPointVector:function(t,e,i,r,a){return null==a&&(a={point:vec3.create(),vector:vec3.create()}),this.quadraticPoint(t,e,r,a.point),this.quadraticVector(t,e,r,a.vector),a},cubicVector:function(t,e,i,r,a,n){null==n&&(n=vec3.create());var s=this.__tmp2,o=this.__tmp3;return s=this.quadraticPoint(t,e,i,a,s),o=this.quadraticPoint(e,i,r,a,o),this.lineVector(s,o,n)},cubicPointVector:function(t,e,i,r,a,n){return null==n&&(n={point:vec3.create(),vector:vec3.create()}),this.cubicPoint(t,e,a,n.point),this.cubicVector(t,e,a,n.vector),n},lineLength:function(t,e){var i=e[0]-t[0],r=e[1]-t[1],a=e[2]-t[2];return Math.sqrt(i*i+r*r+a*a)},squareLineLength:function(t,e){var i=e[0]-t[0],r=e[1]-t[1],a=e[2]-t[2];return i*i+r*r+a*a},quadraticLength:function(t,e,i,r){var a=this.__tmp4,n=this.__tmp5;return a=this.linePoint(t,e,2/3,a),n=this.linePoint(e,i,1/3,n),this.cubicLength(t,a,n,i,r)},cubicLength:function(){var t=function(e,i){for(var r=0,a=0;a<3;a++)r+=Curves.lineLength(e[a],e[a+1]);if(r-Curves.lineLength(e[0],e[3])>i){var n=function(t){for(var e=[t.slice(0)],i=1;i<4;i++){e[i]=[[],[],[],[]];for(var r=0;r<4-i;r++)e[i][r][0]=.5*(e[i-1][r][0]+e[i-1][r+1][0]),e[i][r][1]=.5*(e[i-1][r][1]+e[i-1][r+1][1])}var a=[],n=[];for(r=0;r<4;r++)a[r]=e[r][0],n[r]=e[3-r][r];return[a,n]}(e);r=t(n[0],i)+t(n[1],i)}return r};return function(e,i,r,a,n){return n||(n=1),t([e,i,r,a],n)}}(),quadraticLengthPointVector:function(t,e,i,r,a,n){var s=this.__tmp0,o=this.__tmp1;return s=this.linePoint(t,e,2/3,s),o=this.linePoint(e,i,1/3,o),this.cubicLengthPointVector(t,s,o,i,a,n)},cubicLengthPointVector:function(t,e,i,r,a,n,s){null==s&&(s={point:vec3.create(),vector:vec3.create()});var o=this.cubicLength(t,e,i,r,n),h=this.__tmp4;vec3.set(t,h);var l=this.__tmp5;vec3.set(t,l);for(var u=0,c=0,f=a*o,d=1;d<=20;d++)if(vec3.set(h,l),this.cubicPoint(t,e,i,r,.05*d,h),u=c,(c+=this.lineLength(l,h))>=f){if(c==u)return vec3.set(h,s.point),this.lineVector(t,e,s.vector),s;var g=(c-f)/(c-u);return this.linePoint(l,h,1-g,s.point),this.cubicVector(t,e,i,r,.05*(d-g),s.vector),s}return vec3.set(r,s.point),this.lineVector(i,r,s.vector),s}},Magi.Colors={hsl2rgb:function(t,e,i){var r,a,n;if(0==e)r=a=n=i;else{var s=i<.5?i*(1+e):i+e-i*e,o=2*i-s,h=t%360/360,l=h+1/3,u=h,c=h-1/3;l<0&&l++,l>1&&l--,u<0&&u++,u>1&&u--,c<0&&c++,c>1&&c--,r=l<1/6?o+6*(s-o)*l:l<.5?s:l<2/3?o+6*(s-o)*(2/3-l):o,a=u<1/6?o+6*(s-o)*u:u<.5?s:u<2/3?o+6*(s-o)*(2/3-u):o,n=c<1/6?o+6*(s-o)*c:c<.5?s:c<2/3?o+6*(s-o)*(2/3-c):o}return[r,a,n]},hsv2rgb:function(t,e,i){var r,a,n;if(0==e)r=a=n=i;else{t=t%360/60;var s=Math.floor(t),o=t-s,h=i*(1-e),l=i*(1-e*o),u=i*(1-e*(1-o));switch(s){case 0:r=i,a=u,n=h;break;case 1:r=l,a=i,n=h;break;case 2:r=h,a=i,n=u;break;case 3:r=h,a=l,n=i;break;case 4:r=u,a=h,n=i;break;case 5:r=i,a=h,n=l}}return[r,a,n]}},R=function(t,e){for(var i=[],r=t;r<e;r++)i.push(r);return i},Rg=function(t,e){return R(t,e+1)},Array.prototype.deleteFirst=function(t){for(var e=0;e<this.length;e++)if(this[e]==t)return this.splice(e,1),!0;return!1},Array.prototype.stableSort=function(t){for(var e=0;e<this.length;e++)this[e].__stableSortIndex=e;this.sort(function(e,i){var r=t(e,i);return 0==r&&(r=e.__stableSortIndex-i.__stableSortIndex),r});for(e=0;e<this.length;e++)delete this[e].__stableSortIndex},Array.prototype.all=function(t){for(var e=0;e<this.length;e++)if(!t(this[e],e,this))return!1;return!0},Array.prototype.any=function(t){for(var e=0;e<this.length;e++)if(t(this[e],e,this))return!0;return!1},Array.prototype.allIn=function(t){return this.all(function(e){return null!=t[e]})},Array.prototype.anyIn=function(t){return this.any(function(e){return null!=t[e]})},Array.prototype.equals=function(t){if(!t)return!1;if(this.length!=t.length)return!1;for(var e=0;e<this.length;e++){var i=this[e],r=t[e];if(i.equals&&"function"==typeof i.equals){if(!i.equals(r))return!1}else if(i!=r)return!1}return!0},Array.prototype.rotate=function(t){return t?(this.unshift(this.pop()),this[0]):(this.push(this.shift()),this[this.length-1])},Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]},Array.prototype.flatten=function(){for(var t=[],e=0;e<this.length;e++){var i=this[e];if(i.flatten)for(var r=i.flatten(),a=0;a<r.length;a++)t[t.length]=r[a];else t[t.length]=i}return t},Array.prototype.take=function(){for(var t=[],e=0;e<this.length;e++){for(var i=[],r=0;r<arguments.length;r++)i[r]=this[e][arguments[r]];t[e]=i}return t},Array.prototype.pluck||(Array.prototype.pluck=function(t){for(var e=[],i=0;i<this.length;i++)e[i]=this[i][t];return e}),Array.prototype.setProperty=function(t,e){for(var i=0;i<this.length;i++)this[i][t]=e},Object.match=function(t,e){for(var i in e){var r=e[i];if("object"==typeof t[i]&&"object"==typeof r){if(!Object.match(t[i],r))return!1}else if(t[i]!=r)return!1}},Array.prototype.allWith=function(){var t=[];t:for(var e=0;e<this.length;e++){for(var i=this[e],r=0;r<arguments.length;r++){var a=arguments[r];if("object"==typeof a){if(!Object.match(this[e],a))continue t}else if("function"==typeof a){if(!this[e][a(e)])continue t}else if(!this[e][a])continue t}t[t.length]=i}return t},Array.prototype.bsearch=function(t){for(var e=0,i=this.length-1;e<=i;){var r=e+(i-e>>1),a=this[r];if(a<t)e=r+1;else{if(!(a>t))return r;i=r-1}}return-1},Array.prototype.sortNum=function(){return this.sort(function(t,e){return t>e?1:t<e?-1:0})},Element.prototype.append=function(){for(var t=0;t<arguments.length;t++)"string"==typeof arguments[t]?this.appendChild(T(arguments[t])):this.appendChild(arguments[t])},Function.prototype.bind||(Function.prototype.bind=function(t){var e=this;return function(){return e.apply(t,arguments)}}),Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]}),Array.prototype.indexOf||(Array.prototype.indexOf=function(t){for(var e=0;e<this.length;e++)if(t==this[e])return e;return-1}),Array.prototype.map=function(t){var e=new Array(this.length);if(t)for(var i=0;i<this.length;i++)e[i]=t(this[i],i,this);else for(i=0;i<this.length;i++)e[i]=this[i];return e},Array.prototype.unique=function(){for(var t=[this[0]],e=1;e<this.length;e++)this[e]!=this[e-1]&&t.push(this[e]);return t},Array.prototype.forEach=function(t){for(var e=0;e<this.length;e++)t(this[e],e,this)},Array.prototype.set=function(t){this.splice(t.length);for(var e=0;e<t.length;e++)this[e]=t[e];return this},Array.prototype.reduce||(Array.prototype.reduce=function(t,e){var i=0;for(1==arguments.length&&(e=this[0],i++);i<this.length;i++)e=t(e,this[i],i,this);return e}),Array.prototype.find||(Array.prototype.find=function(t){for(var e=0;e<this.length;e++)if(t(this[e],e,this))return this[e]}),String.prototype.capitalize||(String.prototype.capitalize=function(){return this.replace(/^./,this.slice(0,1).toUpperCase())}),String.prototype.escape||(String.prototype.escape=function(){return'"'+this.replace(/"/g,'\\"')+'"'}),String.prototype.splice||(String.prototype.splice=function(t,e,i){return this.slice(0,t)+i+this.slice(t+e)}),String.prototype.strip||(String.prototype.strip=function(){return this.replace(/^\s+|\s+$/g,"")}),Math.sinh||(Math.sinh=function(t){return.5*(Math.exp(t)-Math.exp(-t))},Math.asinh=function(t){return Math.log(t+Math.sqrt(t*t+1))}),Math.cosh||(Math.cosh=function(t){return.5*(Math.exp(t)+Math.exp(-t))},Math.acosh=function(t){return Math.log(t+Math.sqrt(t*t-1))}),Math.Ln2=Math.log(2),Math.Ln10=Math.log(10),Math.log2=function(t){return Math.log(t)/Math.Ln2},Math.log10=function(t){return Math.log(t)/Math.Ln10},Math.isPowerOfTwo=function(t){var e=Math.log2(t);return Math.floor(e)==e},E=function(t){for(var e=document.createElement(t),i=1;i<arguments.length;i++){var r=arguments[i];if("string"==typeof r)e.innerHTML+=r;else if(r.DOCUMENT_NODE)e.appendChild(r);else if(r.length)for(var a=0;a<r.length;a++){var n=r[a];r.DOCUMENT_NODE?e.appendChild(n):e.innerHTML+=n}else{if(r.style){var s=r.style;delete(r=Object.clone(r)).style,Object.forceExtend(e.style,s)}if(r.content){if("string"==typeof r.content)e.appendChild(T(r.content));else{var o=r.content;o.length||(o=[o]),o.forEach(function(t){e.appendChild(t)})}delete(r=Object.clone(r)).content}Object.forceExtend(e,r)}}return e},E.lastCanvasId=0,E.canvas=function(t,e,i){var r="canvas-uuid-"+E.lastCanvasId;return E.lastCanvasId++,i||(i={}),E("canvas",Object.extend(i,{id:r,width:t,height:e}))},E.byId=function(t){return document.getElementById(t)},E.byClass=function(t){return toArray(document.getElementsByClassName(t))},E.byTag=function(t){return toArray(document.getElementsByTagName(t))},"undefined"==typeof byId&&(byId=E.byId),"undefined"==typeof byClass&&(byClass=E.byClass),"undefined"==typeof byTag&&(byTag=E.byTag),E.make=function(t){return function(){for(var e=[t],i=0;i<arguments.length;i++)e.push(arguments[i]);return E.apply(E,e)}},E.tags="a abbr acronym address area audio b base bdo big blockquote body br button canvas caption center cite code col colgroup dd del dfn div dl dt em fieldset form frame frameset h1 h2 h3 h4 h5 h6 head hr html i iframe img input ins kbd label legend li link map meta noframes noscript object ol optgroup option p param pre q s samp script select small span strike strong style sub sup table tbody td textarea tfoot th thead title tr tt u ul var video".toUpperCase().split(" "),function(){E.tags.forEach(function(t){window[t]=E[t]=E.make(t)});["SUBMIT","TEXT","RESET","HIDDEN","CHECKBOX"].forEach(function(t){var e;window[t]=E[t]=(e=t,function(t){var i=[{type:e}],r=0;for("string"==typeof t&&(i[0].value=t,r++);r<arguments.length;r++)i.push(arguments[r]);return E.INPUT.apply(E,i)})})}(),E.cropImage=function(t,e,i,r,a){var n=t.cloneNode(!1);Object.forceExtend(n.style,{position:"relative",left:-e+"px",top:-i+"px",margin:"0px",padding:"0px",border:"0px"});var s=E("div",{style:{display:"block",width:r+"px",height:a+"px",overflow:"hidden"}});return s.appendChild(n),s},T=function(t){return document.createTextNode(t)},Object.conditionalExtend=function(t,e){for(var i in e)null==t[i]&&(t[i]=e[i]);return t},Object.clone=function(src){if(!src||1==src)return src;switch(typeof src){case"string":return Object.extend(src+"",src);case"number":return src;case"function":return obj=eval(src.toSource()),Object.extend(obj,src);case"object":return src instanceof Array?Object.extend([],src):Object.extend({},src)}},Image.load=function(t,e){var i=new Image;return e&&(i.onload=e),i.src=t,i},Object.isImageLoaded=function(t){return"CANVAS"==t.tagName||("VIDEO"==t.tagName?t.duration>0:!!t.complete&&((null==t.naturalWidth||0!=t.naturalWidth)&&(null!=t.width&&0!=t.width)))},Object.sum=function(t,e){if(t instanceof Array){if(e instanceof Array){for(var i=[],r=0;r<t.length;r++)i[r]=t[r]+e[r];return i}return t.map(function(t){return t+e})}return e instanceof Array?e.map(function(e){return e+t}):t+e},Object.sub=function(t,e){if(t instanceof Array){if(e instanceof Array){for(var i=[],r=0;r<t.length;r++)i[r]=t[r]-e[r];return i}return t.map(function(t){return t-e})}return e instanceof Array?e.map(function(e){return t-e}):t-e},Object.clear=function(t){for(var e in t)delete t[e];return t},window.Mouse||(Mouse={}),Mouse.getRelativeCoords=function(t,e){for(var i={x:0,y:0},r=0,a=0,n=t;n;)r+=n.offsetLeft,a+=n.offsetTop,n=n.offsetParent;return i.x=e.pageX-r,i.y=e.pageY-a,i},Browser=function(){var t=window.navigator.userAgent,e=t.match(/Chrome\/\d+/),i=t.match(/Safari/),r=t.match(/Mobile/),a=t.match(/WebKit\/\d+/),n=t.match(/KHTML/),s=t.match(/Gecko/),o=t.match(/Explorer/);return e?"Chrome":r&&i?"Mobile Safari":i?"Safari":a?"Webkit":n?"KHTML":s?"Gecko":o?"IE":"UNKNOWN"}(),Mouse.LEFT=0,Mouse.MIDDLE=1,Mouse.RIGHT=2,"IE"==Browser&&(Mouse.LEFT=1,Mouse.MIDDLE=4),Mouse.state={},window.addEventListener("mousedown",function(t){Mouse.state[t.button]=!0},!0),window.addEventListener("mouseup",function(t){Mouse.state[t.button]=!1},!0),Event={cancel:function(t){t.preventDefault&&t.preventDefault()},stop:function(t){Event.cancel(t),t.stopPropagation&&t.stopPropagation()}},Key={matchCode:function(t,e){if("string"==typeof e){var i=e.toLowerCase().charCodeAt(0),r=e.toUpperCase().charCodeAt(0);return t.which==i||t.which==r||t.keyCode==i||t.keyCode==r||t.charCode==i||t.charCode==r}return t.which==e||t.keyCode==e||t.charCode==e},match:function(t,e){for(var i=1;i<arguments.length;i++){var r=arguments[i];if(null!=r)if(null!=r.length&&"string"!=typeof r){for(var a=0;a<r.length;a++)if(Key.matchCode(t,r[a]))return!0}else if(Key.matchCode(t,r))return!0}return!1},isNumber:function(t,e){var i=t.which||t.keyCode||t.charCode;return i>=Key.N_0&&i<=Key.N_9},number:function(t,e){var i=t.which||t.keyCode||t.charCode;return i<Key.N_0||i>Key.N_9?NaN:i-Key.N_0},getString:function(t){var e=t.which||t.keyCode||t.charCode;return String.fromCharCode(e)},N_0:48,N_1:49,N_2:50,N_3:51,N_4:52,N_5:53,N_6:54,N_7:55,N_8:56,N_9:57,BACKSPACE:8,TAB:9,ENTER:13,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46},void 0===window.Query&&(window.Query={}),Object.extend(window.Query,{parse:function(t){var e={};return t?(t.split("&").forEach(function(t){var i=t.replace(/\+/g," ").split("=").map(decodeURIComponent);e[i[0]]=i[1]}),e):e},build:function(t){if("string"==typeof t)return encodeURIComponent(t);if(t instanceof Array)e=t;else{var e=[];for(var i in t)null!=t[i]&&e.push([i,t[i]])}return e.map(function(t){return t.map(encodeURIComponent).join("=")}).join("&")}}),void 0===window.URL&&(window.URL={}),Object.extend(window.URL,{build:function(t,e,i){return t+(null!=e?"?"+Query.build(e):"")+(null!=i?"#"+Query.build(i):"")},parse:function(t){var e=t.split("#"),i=e[0].split("?"),r=i[0],a=r.split("://"),n=a[0];return{base:r,path:a[1]||a[0],protocol:n,query:Query.parse(i[1]),fragment:e[1],build:URL.__build__}},__build__:function(){return URL.build(this.base,this.query,this.fragment)}}),Magi.log=function(t){if(window.console&&console.log(t),this.logCanvas){var e=this.logCanvas,i=e.getContext("2d");i.font="14px Sans-serif",i.textAlign="center",i.fillStyle="#c24",i.fillText(t,e.width/2,e.height/2,e.width-20)}this.logElement&&this.logElement.appendChild(P(T(t)))},Magi.GL_CONTEXT_ID=null,Magi.GL_ID_NUM=0,Magi.findGLContextId=function(t,e){for(var i=["webgl","experimental-webgl"],r=0;r<i.length;r++){var a=i[r];try{if(t.getContext(a,e))return a}catch(t){}}return!1},Magi.getGLContext=function(t,e){if(this.GL_CONTEXT_ID||(this.GL_CONTEXT_ID=Magi.findGLContextId(t,e)),this.GL_CONTEXT_ID){var i=t.getContext(this.GL_CONTEXT_ID,e);return i.id=Magi.GL_ID_NUM++,i}this.logCanvas=t,this.log("No WebGL context found. Click here for more details.");var r=document.createElement("a");r.href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation",t.parentNode.insertBefore(r,t),r.appendChild(t)},Magi.errorName=function(t,e){var i=[];for(var r in t)t[r]==e&&i.push(r);return i.join("|")},Magi.checkError=function(t,e){if(0!=Magi.DEBUG){var i=t.getError();return 0!=i&&Magi.log("Error "+i+":"+Magi.errorName(t,i)+" at "+e),i}},Magi.throwError=function(t,e){if(0!=Magi.DEBUG){var i=t.getError();if(0!=i)throw new Error("Error "+i+":"+Magi.errorName(t,i)+" at "+e)}},Magi.AllocatedResources={textures:[],vbos:[],shaders:[],fbos:[],deleteAll:function(){for(;this.textures.length>0;)this.textures[0].permanent=!1,this.textures[0].destroy();for(;this.vbos.length>0;)this.vbos[0].destroy();for(;this.fbos.length>0;)this.fbos[0].destroy();for(;this.shaders.length>0;)this.shaders[0].destroy()},addTexture:function(t){-1==this.textures.indexOf(t)&&this.textures.push(t)},addShader:function(t){-1==this.shaders.indexOf(t)&&this.shaders.push(t)},addVBO:function(t){-1==this.vbos.indexOf(t)&&this.vbos.push(t)},addFBO:function(t){-1==this.fbos.indexOf(t)&&this.fbos.push(t)},deleteTexture:function(t){var e=this.textures.indexOf(t);e>=0&&this.textures.splice(e,1)},deleteShader:function(t){var e=this.shaders.indexOf(t);e>=0&&this.shaders.splice(e,1)},deleteVBO:function(t){var e=this.vbos.indexOf(t);e>=0&&this.vbos.splice(e,1)},deleteFBO:function(t){var e=this.fbos.indexOf(t);e>=0&&this.fbos.splice(e,1)}},window.addEventListener("unload",function(){Magi.AllocatedResources.deleteAll()},!1),Magi.Texture=Klass({target:"TEXTURE_2D",generateMipmaps:!0,width:null,height:null,data:null,changed:!1,initialize:function(t){this.gl=t,Magi.AllocatedResources.addTexture(this)},load:function(t,e,i){var r=new Image,a=new Magi.Texture;return a.generateMipmaps=i,r.onload=function(){a.changed=!0,e&&e(a)},r.src=t,a.image=r,a},defaultTexCache:{},getDefaultTexture:function(t){var e=0;if(t&&(e=t.id||1),!this.defaultTexCache[e]){var i=new this(t);i.image=E.canvas(1,1),i.generateMipmaps=!1,this.defaultTexCache[e]=i}return this.defaultTexCache[e]},upload:function(){var t=this.gl,e=t[this.target];if(this.image){var i=this.image;if(!Object.isImageLoaded(i))return void(this.changed=!0);("IMG"==this.image.tagName&&/\.svgz?$/i.test(this.image.src)||"VIDEO"==this.image.tagName&&/WebKit\/\d+/.test(window.navigator.userAgent))&&(this.image.tmpCanvas&&this.image.tmpCanvas.width==this.image.width&&this.image.tmpCanvas.height==this.image.height||(this.image.tmpCanvas=E.canvas(this.image.width,this.image.height)),this.image.tmpCanvas.getContext("2d").drawImage(this.image,0,0,this.image.width,this.image.height),i=this.image.tmpCanvas),this.width=i.naturalWidth||i.videoWidth||i.width,this.height=i.naturalHeight||i.videoHeight||i.height,this.previousWidth==this.width&&this.previousHeight==this.height?t.texSubImage2D(e,0,0,0,t.RGBA,t.UNSIGNED_BYTE,i):t.texImage2D(e,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i)}else this.previousWidth==this.width&&this.previousHeight==this.height?t.texSubImage2D(e,0,0,0,this.width,this.height,t.RGBA,t.UNSIGNED_BYTE,this.data):t.texImage2D(e,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,this.data);this.previousWidth=this.width,this.previousHeight=this.height,Magi.throwError(t,"Texture.upload")},regenerateMipmap:function(){var t=this.gl,e=t[this.target];if(t.texParameteri(e,t.TEXTURE_MIN_FILTER,t.LINEAR),this.generateMipmaps)if(this.width==this.height&&Math.isPowerOfTwo(this.width))t.generateMipmap(e),Magi.throwError(t,"Texture.regenerateMipmap: generateMipmap"),t.texParameteri(e,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR);else if(this.image){for(var i=this.width,r=this.height,a=Math.floor(Math.log2(Math.max(i,r))+.1)+1,n=this.image,s=1;s<a;s++){var o=Math.max(1,Math.floor(i/Math.pow(2,s)+.1)),h=Math.max(1,Math.floor(r/Math.pow(2,s)+.1)),l=E.canvas(o,h),u=l.getContext("2d");u.globalCompositeOperation="copy",u.drawImage(n,0,0,o,h),t.texImage2D(e,s,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,l),Magi.throwError(t,"Texture.regenerateMipmap loop: "+[s,o,h].join(",")),n=l}t.texParameteri(e,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR)}},compile:function(){var t=this.gl,e=t[this.target];this.textureObject=t.createTexture(),Magi.Stats.textureCreationCount++,t.bindTexture(e,this.textureObject),Magi.throwError(t,"Texture.compile"),this.upload(),t.texParameteri(e,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(e,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(e,t.TEXTURE_MAG_FILTER,t.LINEAR),this.regenerateMipmap()},needsUpload:function(){return this.image&&"VIDEO"==this.image.tagName&&this.image.currentTime!=this.previousVideoTime?(this.previousVideoTime=this.image.currentTime,!0):!(!this.image||"CANVAS"!=this.image.tagName||!this.image.changed)||this.changed},use:function(){null==this.textureObject&&this.compile(),this.gl.bindTexture(this.gl[this.target],this.textureObject),this.needsUpload()&&(this.changed=!1,this.upload(),this.regenerateMipmap())},clear:function(){1!=this.permanent&&(this.textureObject&&this.gl.deleteTexture(this.textureObject),this.previousWidth=this.previousHeight=null,this.textureObject=null)},destroy:function(){1!=this.permanent&&(this.clear(),Magi.AllocatedResources.deleteTexture(this))}}),Magi.Shader=Klass({id:null,gl:null,compiled:!1,shader:null,shaders:[],initialize:function(t){this.gl=t,this.shaders=[],this.uniformLocations={},this.attribLocations={};for(var e=1;e<arguments.length;e++)this.shaders.push(arguments[e]);Magi.AllocatedResources.addShader(this)},destroy:function(){null!=this.shader&&Magi.Shader.deleteShader(this.gl,this.shader),Magi.AllocatedResources.deleteShader(this)},compile:function(){this.shader=Magi.Shader.getProgramByMixedArray(this.gl,this.shaders)},use:function(){null==this.shader&&this.compile(),this.gl.useProgram(this.shader.program)},getInfoLog:function(){null==this.shader&&this.compile();var t=this.gl;return t.getProgramInfoLog(this.shader.program)+"\n\n"+this.shader.shaders.map(function(e){return t.getShaderInfoLog(e)}).join("\n\n")},uniform1fv:function(t,e){var i=this.uniform(t).index;null!=i&&this.gl.uniform1fv(i,e)},uniform2fv:function(t,e){var i=this.uniform(t).index;null!=i&&this.gl.uniform2fv(i,e)},uniform3fv:function(t,e){var i=this.uniform(t).index;null!=i&&this.gl.uniform3fv(i,e)},uniform4fv:function(t,e){var i=this.uniform(t).index;null!=i&&this.gl.uniform4fv(i,e)},uniform1f:function(t,e){var i=this.uniform(t).index;null!=i&&this.gl.uniform1f(i,e)},uniform2f:function(t,e,i){var r=this.uniform(t).index;null!=r&&this.gl.uniform2f(r,e,i)},uniform3f:function(t,e,i,r){var a=this.uniform(t).index;null!=a&&this.gl.uniform3f(a,e,i,r)},uniform4f:function(t,e,i,r,a){var n=this.uniform(t).index;null!=n&&this.gl.uniform4f(n,e,i,r,a)},uniform1iv:function(t,e){var i=this.uniform(t).index;null!=i&&this.gl.uniform1iv(i,e)},uniform2iv:function(t,e){var i=this.uniform(t).index;null!=i&&this.gl.uniform2iv(i,e)},uniform3iv:function(t,e){var i=this.uniform(t).index;null!=i&&this.gl.uniform3iv(i,e)},uniform4iv:function(t,e){var i=this.uniform(t).index;null!=i&&this.gl.uniform4iv(i,e)},uniform1i:function(t,e){var i=this.uniform(t).index;null!=i&&this.gl.uniform1i(i,e)},uniform2i:function(t,e,i){var r=this.uniform(t).index;null!=r&&this.gl.uniform2i(r,e,i)},uniform3i:function(t,e,i,r){var a=this.uniform(t).index;null!=a&&this.gl.uniform3i(a,e,i,r)},uniform4i:function(t,e,i,r,a){var n=this.uniform(t).index;null!=n&&this.gl.uniform4i(n,e,i,r,a)},uniformMatrix4fv:function(t,e){var i=this.uniform(t).index;null!=i&&this.gl.uniformMatrix4fv(i,!1,e)},uniformMatrix3fv:function(t,e){var i=this.uniform(t).index;null!=i&&this.gl.uniformMatrix3fv(i,!1,e)},uniformMatrix2fv:function(t,e){var i=this.uniform(t).index;null!=i&&this.gl.uniformMatrix2fv(i,!1,e)},attrib:function(t){if(null==this.attribLocations[t]){var e=this.gl.getAttribLocation(this.shader.program,t);this.attribLocations[t]={index:e,current:null}}return this.attribLocations[t]},uniform:function(t){if(null==this.uniformLocations[t]){var e=this.gl.getUniformLocation(this.shader.program,t);this.uniformLocations[t]={index:e,current:null}}return this.uniformLocations[t]}}),Magi.Shader.createShader=function(t,e,i){"string"==typeof e&&(e=t[e]);var r=t.createShader(e);if(t.shaderSource(r,i),t.compileShader(r),1!=t.getShaderParameter(r,t.COMPILE_STATUS)){var a=t.getShaderInfoLog(r);throw t.deleteShader(r),new Error("Failed to compile shader. Shader info log: "+a+" Shader source: "+i)}return r},Magi.Shader.getShaderById=function(t,e){var i=document.getElementById(e);if(!i)throw new Error("getShaderById: No element has id "+e);var r,a=i.getAttribute("type");if("text/x-glsl-fs"==a)r=t.FRAGMENT_SHADER;else{if("text/x-glsl-vs"!=a)throw new Error("getShaderById: Unknown shader type "+a);r=t.VERTEX_SHADER}return this.createShader(t,r,i.textContent)},Magi.Shader.loadShader=function(t,e,i,r,a){if(!a){var n=e.split("."),s=n[n.length-1].toLowerCase();if("frag"==s)a=t.FRAGMENT_SHADER;else{if("vert"!=s)throw new Error("loadShader: Unknown shader extension "+s);a=t.VERTEX_SHADER}}var o=this,h=new XMLHttpRequest;return h.onsuccess=function(e){var r=o.createShader(t,a,e.responseText);i(r,e)},h.onerror=function(t){if(!r)throw new Error("loadShader: Failed to load shader "+t.status);r(t)},h.open("GET",e,!0),h.send(null),h},Magi.Shader.createProgram=function(t,e){for(var i=t.createProgram(),r=[],a=0;a<e.length;++a)try{var n=e[a];r.push(n),t.attachShader(i,n)}catch(e){var s={program:i,shaders:r};throw this.deleteShader(t,s),e}var o={program:i,shaders:r};if(t.linkProgram(i),t.validateProgram(i),1!=t.getProgramParameter(i,t.LINK_STATUS))throw this.deleteShader(t,o),new Error("Failed to link shader: "+t.getProgramInfoLog(i));if(1!=t.getProgramParameter(i,t.VALIDATE_STATUS))throw this.deleteShader(t,o),new Error("Failed to validate shader");return o},Magi.Shader.loadProgramArray=function(t,e,i,r){var a,n=this,s=e.slice(0),o=[];a=function(e){if(o.push(e),0==s.length)try{var h=n.createProgram(t,o);i(h)}catch(t){r(t)}else{var l=s.shift();n.loadShader(t,l,a,r)}};var h=s.shift();n.loadShader(t,h,a,r)},Magi.Shader.loadProgram=function(t,e){for(var i=[],r=1;r<arguments.length;++r)i.push(arguments[r]);return this.loadProgramArray(t,i,e)},Magi.Shader.getProgramBySourceArray=function(t,e){var i=this,r=e.map(function(e){return i.createShader(t,e.type,e.text)});return this.createProgram(t,r)},Magi.Shader.getProgramByIdArray=function(t,e){var i=this,r=e.map(function(e){return i.getShaderById(t,e)});return this.createProgram(t,r)},Magi.Shader.getProgramByMixedArray=function(t,e){var i=this,r=e.map(function(e){return e.type?i.createShader(t,e.type,e.text):i.getShaderById(t,e)});return this.createProgram(t,r)},Magi.Shader.getProgramByIds=function(t){for(var e=[],i=1;i<arguments.length;++i)e.push(arguments[i]);return this.getProgramByIdArray(t,e)},Magi.Shader.deleteShader=function(t,e){t.useProgram(null),e.shaders.forEach(function(i){t.detachShader(e.program,i),t.deleteShader(i)}),t.deleteProgram(e.program)},Magi.Shader.load=function(t,e){for(var i=[],r=1;r<arguments.length;++r)i.push(arguments[r]);var a=new Shader(t);Magi.Shader.loadProgramArray(t,i,function(t){a.shader=t,a.compile=function(){},e(a)})},Magi.Filter=Klass(Magi.Shader,{initialize:function(t,e){Magi.Shader.initialize.apply(this,arguments)},apply:function(t){this.use();var e=this.attrib("Vertex"),i=this.attrib("TexCoord"),r=Magi.Geometry.Quad.getCachedVBO(this.gl);t&&t(this),r.draw(e,null,i)}}),Magi.VBO=Klass({initialized:!1,offset:0,length:0,vbos:null,type:"TRIANGLES",elementsVBO:null,elements:null,initialize:function(t){this.gl=t,this.data=[],this.elementsVBO=null;for(var e=1;e<arguments.length;e++)arguments[e].elements?this.elements=arguments[e]:this.data.push(arguments[e]);Magi.AllocatedResources.addVBO(this)},setData:function(){this.clear(),this.data=[];for(var t=0;t<arguments.length;t++)arguments[t].elements?this.elements=arguments[t]:this.data.push(arguments[t])},clear:function(){if(null!=this.vbos)for(var t=0;t<this.vbos.length;t++)this.gl.deleteBuffer(this.vbos[t]);null!=this.elementsVBO&&this.gl.deleteBuffer(this.elementsVBO),this.length=this.elementsLength=0,this.vbos=this.elementsVBO=null,this.initialized=!1},destroy:function(){this.clear(),Magi.AllocatedResources.deleteVBO(this)},init:function(){this.clear();var t=this.gl;t.getError();for(var e=[],i=0,r=0;r<this.data.length;r++)e.push(t.createBuffer());null!=this.elements&&(this.elementsVBO=t.createBuffer());try{Magi.throwError(t,"genBuffers");for(r=0;r<this.data.length;r++){if(null!=(n=this.data[r]).data){var a=Math.floor(n.data.length/n.size);if((0==r||a<i)&&(i=a),!n.typedArray)switch(n.type){case t.UNSIGNED_INT:n.typedArray=new Uint32Array(n.data);break;case t.INT:n.typedArray=new Int32Array(n.data);break;case t.UNSIGNED_SHORT:n.typedArray=new Uint16Array(n.data);break;case t.SHORT:n.typedArray=new Int16Array(n.data);break;case t.UNSIGNED_BYTE:n.typedArray=new Uint8Array(n.data);break;case t.BYTE:n.typedArray=new Int8Array(n.data);break;default:n.type=t.FLOAT,n.typedArray=new Float32Array(n.data)}t.bindBuffer(t.ARRAY_BUFFER,e[r]),Magi.Stats.bindBufferCount++,Magi.throwError(t,"bindBuffer"),t.bufferData(t.ARRAY_BUFFER,n.typedArray,t.STATIC_DRAW),Magi.throwError(t,"bufferData")}}if(null!=this.elementsVBO){var n=this.elements;this.elementsLength=n.data.length,this.elementsType=n.type==t.UNSIGNED_BYTE?t.UNSIGNED_BYTE:t.UNSIGNED_SHORT,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.elementsVBO),Magi.Stats.bindBufferCount++,Magi.throwError(t,"bindBuffer ELEMENT_ARRAY_BUFFER"),n.typedArray||(this.elementsType==t.UNSIGNED_SHORT?n.typedArray=new Uint16Array(n.data):this.elementsType==t.UNSIGNED_BYTE&&(n.typedArray=new Uint8Array(n.data)),t.bufferData(t.ELEMENT_ARRAY_BUFFER,n.typedArray,t.STATIC_DRAW)),Magi.throwError(t,"bufferData ELEMENT_ARRAY_BUFFER")}}catch(i){for(r=0;r<e.length;r++)t.deleteBuffer(e[r]);throw i}t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),Magi.Stats.bindBufferCount++,Magi.Stats.bindBufferCount++,this.length=i,this.vbos=e,this.initialized=!0},use:function(){this.initialized||this.init();for(var t=this.gl,e=0;e<arguments.length;e++){var i=arguments[e],r=this.data[e]&&null!=this.data[e].data?this.vbos[e]:null;null!=i&&null!=i.index&&-1!=i.index&&(r?(Magi.VBO[i.index]!==r&&(t.bindBuffer(t.ARRAY_BUFFER,r),t.vertexAttribPointer(i.index,this.data[e].size,this.data[e].type,!1,0,0),Magi.Stats.bindBufferCount++,Magi.Stats.vertexAttribPointerCount++),t.enableVertexAttribArray(i.index),Magi.VBO[i.index]=r):t.disableVertexAttribArray(i.index))}null!=this.elementsVBO&&(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.elementsVBO),Magi.Stats.bindBufferCount++)},draw:function(){this.use.apply(this,arguments);var t=this.gl;null!=this.elementsVBO?(t.drawElements(t[this.type],this.elementsLength,this.elementsType,this.offset),Magi.Stats.drawElementsCount++):(t.drawArrays(t[this.type],this.offset,this.length),Magi.Stats.drawArraysCount++)}}),Magi.FBO=Klass({initialized:!1,useDepth:!0,fbo:null,rbo:null,texture:null,initialize:function(t,e,i,r){this.gl=t,this.width=e,this.height=i,null!=r&&(this.useDepth=r),Magi.AllocatedResources.addFBO(this)},destroy:function(){this.fbo&&this.gl.deleteFramebuffer(this.fbo),this.rbo&&this.gl.deleteRenderbuffer(this.rbo),this.texture&&(this.texture.permanent=!1,this.texture.destroy()),Magi.AllocatedResources.deleteFBO(this)},setSize:function(t,e){if((t!=this.width||e!=this.height)&&(this.width=t,this.height=e,this.initialized)){var i=this.gl;this.texture.width=this.width,this.texture.height=this.height,this.texture.changed=!0,this.texture.use(),this.useDepth&&(i.bindRenderbuffer(i.RENDERBUFFER,this.rbo),Magi.throwError(i,"FBO.resize bindRenderbuffer"),i.renderbufferStorage(i.RENDERBUFFER,i.stencilWorks?i.DEPTH_STENCIL:i.DEPTH_COMPONENT16,this.width,this.height),Magi.throwError(i,"FBO.resize renderbufferStorage"))}},resize:function(t,e){return this.setSize(t,e)},init:function(){var t,e=this.gl,i=this.width,r=this.height,a=null!=this.fbo?this.fbo:e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,a),Magi.throwError(e,"FBO.init bindFramebuffer");var n=null!=this.texture?this.texture:new Magi.Texture(e);if(n.width=i,n.height=r,n.data=null,n.generateMipmaps=!1,n.permanent=!0,n.use(),Magi.throwError(e,"FBO.init tex"),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n.textureObject,0),Magi.throwError(e,"FBO.init bind tex"),this.useDepth){t=null!=this.rbo?this.rbo:e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,t),Magi.throwError(e,"FBO.init bindRenderbuffer");try{e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,i,r),Magi.throwError(e,"FBO.init depth renderbufferStorage"),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t),Magi.throwError(e,"FBO.init bind depth buffer"),e.stencilWorks=!0}catch(t){e.stencilWorks=!1}e.stencilWorks||(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,i,r),Magi.throwError(e,"FBO.init depth renderbufferStorage"),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t),Magi.throwError(e,"FBO.init bind depth buffer"))}var s,o=e.checkFramebufferStatus(e.FRAMEBUFFER);if(o!=e.FRAMEBUFFER_COMPLETE)for(var h in e){try{s=e[h]}catch(t){s=null}if(s==o){o=h;break}}Magi.throwError(e,"FBO.init check fbo"),this.fbo=a,this.rbo=t,this.texture=n,this.initialized=!0},use:function(){this.initialized||this.init(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo),Magi.throwError(this.gl,"FBO.use")}}),Magi.makeGLErrorWrapper=function(t,e){return function(){var i;try{i=t[e].apply(t,arguments)}catch(r){throw new Error("GL error "+r.name+" in "+e+"\n"+r.message+"\n"+arguments.callee.caller)}var r=t.getError();if(0!=r)throw new Error("GL error "+r+" in "+e);return i}},Magi.wrapGLContext=function(t){var e={};for(var i in t)try{"function"==typeof t[i]?e[i]=Magi.makeGLErrorWrapper(t,i):e[i]=t[i]}catch(t){}return e.getError=function(){return t.getError()},e},Magi.Geometry={},Magi.Geometry.Quad={vertices:new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,-1,0,1,1,0,-1,1,0]),normals:new Float32Array([0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1]),texcoords:new Float32Array([0,0,1,0,0,1,1,0,1,1,0,1]),indices:new Float32Array([0,1,2,1,5,2]),makeVBO:function(t){return new Magi.VBO(t,{size:3,data:this.vertices},{size:3,data:this.normals},{size:2,data:this.texcoords})},cache:{},getCachedVBO:function(t){var e=0;return t&&(e=t.id||1),this.cache[e]||(this.cache[e]=this.makeVBO(t)),this.cache[e]}},Magi.Geometry.QuadMesh={makeVBO:function(t,e,i){for(var r=[],a=[],n=[],s=0;s<e;s++)for(var o=0;o<i;o++)r.push((s-e/2)/(e/2),(o-i/2)/(i/2),0),r.push((s+1-e/2)/(e/2),(o-i/2)/(i/2),0),r.push((s-e/2)/(e/2),(o+1-i/2)/(i/2),0),r.push((s+1-e/2)/(e/2),(o-i/2)/(i/2),0),r.push((s+1-e/2)/(e/2),(o+1-i/2)/(i/2),0),r.push((s-e/2)/(e/2),(o+1-i/2)/(i/2),0),a.push(0,0,-1),a.push(0,0,-1),a.push(0,0,-1),a.push(0,0,-1),a.push(0,0,-1),a.push(0,0,-1),n.push(s/e,o/i),n.push((s+1)/e,o/i),n.push(s/e,(o+1)/i),n.push((s+1)/e,o/i),n.push((s+1)/e,(o+1)/i),n.push(s/e,(o+1)/i);return new Magi.VBO(t,{size:3,data:new Float32Array(r)},{size:3,data:new Float32Array(a)},{size:2,data:new Float32Array(n)})},cache:{},getCachedVBO:function(t,e,i){var r=(e=e||50)+":"+(i=i||50),a=0;return t&&(a=t.id||1),this.cache[a]||(this.cache[a]={}),this.cache[a][r]||(this.cache[a][r]=this.makeVBO(t,e,i)),this.cache[a][r]}},Magi.Geometry.Cube={vertices:new Float32Array([.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,.5,.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5]),normals:new Float32Array([1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1]),texcoords:new Float32Array([0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0]),indices:[],create:function(){for(var t=0;t<6;t++)this.indices.push(4*t+0),this.indices.push(4*t+1),this.indices.push(4*t+3),this.indices.push(4*t+1),this.indices.push(4*t+2),this.indices.push(4*t+3);this.indices=new Float32Array(this.indices)},makeVBO:function(t){return new Magi.VBO(t,{size:3,data:this.vertices},{size:3,data:this.normals},{size:2,data:this.texcoords},{elements:!0,data:this.indices})},cache:{},getCachedVBO:function(t){var e=0;return t&&(e=t.id||1),this.cache[e]||(this.cache[e]=this.makeVBO(t)),this.cache[e]}},Magi.Geometry.Cube.create(),Magi.Geometry.CubeArray={pushNormals:function(t,e){t.push(Magi.Geometry.Cube.normals[3*e+0]),t.push(Magi.Geometry.Cube.normals[3*e+1]),t.push(Magi.Geometry.Cube.normals[3*e+2])},pushCubeNormals:function(t){for(var e=0;e<6;e++)this.pushNormals(t,4*e+0),this.pushNormals(t,4*e+1),this.pushNormals(t,4*e+3),this.pushNormals(t,4*e+1),this.pushNormals(t,4*e+2),this.pushNormals(t,4*e+3)},pushCubeVerts:function(t,e,i,r,a,n){t.push((2*Magi.Geometry.Cube.vertices[3*n+0]+1+2*e)/r-1),t.push((2*Magi.Geometry.Cube.vertices[3*n+1]+1+2*i)/a-1),t.push(Magi.Geometry.Cube.vertices[3*n+2])},pushCube:function(t,e,i,r,a){for(var n=0;n<6;n++)this.pushCubeVerts(t,e,i,r,a,4*n+0),this.pushCubeVerts(t,e,i,r,a,4*n+1),this.pushCubeVerts(t,e,i,r,a,4*n+3),this.pushCubeVerts(t,e,i,r,a,4*n+1),this.pushCubeVerts(t,e,i,r,a,4*n+2),this.pushCubeVerts(t,e,i,r,a,4*n+3)},makeVBO:function(t,e,i){for(var r=[],a=[],n=[],s=0;s<e;s++)for(var o=0;o<i;o++){this.pushCube(r,s,o,e,i),this.pushCubeNormals(a);for(var h=0;h<36;h++)n.push(s/e,o/i)}return new Magi.VBO(t,{size:3,data:new Float32Array(r)},{size:3,data:new Float32Array(a)},{size:2,data:new Float32Array(n)})},cache:{},getCachedVBO:function(t,e,i){var r=(e=e||50)+":"+(i=i||50),a=0;return t&&(a=t.id||1),this.cache[a]||(this.cache[a]={}),this.cache[a][r]||(this.cache[a][r]=this.makeVBO(t,e,i)),this.cache[a][r]}},Magi.Geometry.Sphere={vert:function(t,e,i,r,a,n){var s,o,h,l,u,c;l=Math.sin(t)*Math.cos(e),c=Math.sin(e),u=Math.cos(t)*Math.cos(e),r.push(l,u,c),s=Math.sin(t)*Math.cos(e),h=Math.sin(e),o=Math.cos(t)*Math.cos(e),i.push(s,o,h),a.push(1-t/(2*Math.PI),n?(e+Math.PI/2)/Math.PI:.5+.5*Math.sin(e))},makeVBO:function(t,e,i,r){for(var a=[],n=[],s=[],o=0;o<i;o++)for(var h=-Math.PI/2+Math.PI*o/i,l=h+Math.PI/i,u=0;u<e;u++){var c=2*Math.PI*u/e,f=c+2*Math.PI/e;this.vert(c,h,a,n,s,r),this.vert(c,l,a,n,s,r),this.vert(f,l,a,n,s,r),this.vert(c,h,a,n,s,r),this.vert(f,l,a,n,s,r),this.vert(f,h,a,n,s,r)}return new Magi.VBO(t,{size:3,data:new Float32Array(a)},{size:3,data:new Float32Array(n)},{size:2,data:new Float32Array(s)})},cache:{},getCachedVBO:function(t,e,i,r){var a=(e=e||10)+":"+(i=i||10)+":"+r,n=0;return t&&(n=t.id||1),this.cache[n]||(this.cache[n]={}),this.cache[n][a]||(this.cache[n][a]=this.makeVBO(t,e,i,r)),this.cache[n][a]}},Magi.Geometry.Disk={OUT:1,IN:2,UP:3,DOWN:4,vert:function(t,e,i,r,a,n,s,o,h){var l=Math.sin(t),u=Math.cos(t),c=l*i,f=u*i;r.push(c,f,e);var d=t/(2*Math.PI);switch(s){case this.OUT:a.push(l,u,0),n.push(d,e/o);break;case this.IN:a.push(-l,-u,0),n.push(d,e/o);break;case this.UP:a.push(0,0,1),n.push(d,h);break;case this.DOWN:a.push(0,0,-1),n.push(d,h)}},makeVBO:function(t,e,i,r,a,n){for(var s=[],o=[],h=[],l=0;l<n;l++)for(var u=l*r/n,c=u+r/n,f=0;f<a;f++){var d=2*f*Math.PI/a,g=d+2*Math.PI/a;this.vert(d,u,i,s,o,h,this.OUT,r,0),this.vert(d,c,i,s,o,h,this.OUT,r,0),this.vert(g,c,i,s,o,h,this.OUT,r,0),this.vert(d,u,i,s,o,h,this.OUT,r,0),this.vert(g,c,i,s,o,h,this.OUT,r,0),this.vert(g,u,i,s,o,h,this.OUT,r,0),this.vert(g,c,e,s,o,h,this.IN,r,0),this.vert(d,c,e,s,o,h,this.IN,r,0),this.vert(d,u,e,s,o,h,this.IN,r,0),this.vert(g,u,e,s,o,h,this.IN,r,0),this.vert(g,c,e,s,o,h,this.IN,r,0),this.vert(d,u,e,s,o,h,this.IN,r,0),this.vert(d,c,i,s,o,h,this.UP,r,0),this.vert(d,c,e,s,o,h,this.UP,r,1),this.vert(g,c,e,s,o,h,this.UP,r,1),this.vert(d,c,i,s,o,h,this.UP,r,0),this.vert(g,c,e,s,o,h,this.UP,r,1),this.vert(g,c,i,s,o,h,this.UP,r,0),this.vert(g,u,e,s,o,h,this.DOWN,r,1),this.vert(d,u,e,s,o,h,this.DOWN,r,1),this.vert(d,u,i,s,o,h,this.DOWN,r,0),this.vert(g,u,i,s,o,h,this.DOWN,r,0),this.vert(g,u,e,s,o,h,this.DOWN,r,1),this.vert(d,u,i,s,o,h,this.DOWN,r,0)}return new Magi.VBO(t,{size:3,data:new Float32Array(s)},{size:3,data:new Float32Array(o)},{size:2,data:new Float32Array(h)})},cache:{},getCachedVBO:function(t,e,i,r,a,n){var s=[e=null==e?.5:e,i=null==i?1:i,r=null==r?.01:r,a=a||50,n=n||2].join(":"),o=0;return t&&(o=t.id||1),this.cache[o]||(this.cache[o]={}),this.cache[o][s]||(this.cache[o][s]=this.makeVBO(t,e,i,r,a,n)),this.cache[o][s]}},Magi.Geometry.Ring={makeXZQuad:function(t,e,i,r,a,n,s){s.push(t,e,i),s.push(r,e,n),s.push(t,a,i),s.push(r,e,n),s.push(r,a,n),s.push(t,a,i)},makeVBO:function(t,e,i,r,a){for(var n=[],s=[],o=[],h=0;h<i;h++)for(var l=h/i,u=(h+1)/i,c=l*a,f=u*a,d=Math.cos(c),g=Math.cos(f),m=Math.sin(c),p=Math.sin(f),v=0;v<r;v++){var M=2*e*(v/r-.5),x=2*e*((v+1)/r-.5);this.makeXZQuad(d,M,m,g,x,p,n),s.push(m,0,-d),s.push(p,0,-g),s.push(m,0,-d),s.push(p,0,-g),s.push(p,0,-g),s.push(m,0,-d),o.push(l,M),o.push(u,M),o.push(l,x),o.push(u,M),o.push(u,x),o.push(l,x)}return new Magi.VBO(t,{size:3,data:new Float32Array(n)},{size:3,data:new Float32Array(s)},{size:2,data:new Float32Array(o)})},cache:{},getCachedVBO:function(t,e,i,r,a){e=null==e?.1:e;var n=(i=i||256)+":"+(r=r||10)+":"+(a=null==a?2*Math.PI:a)+":"+e,s=0;return t&&(s=t.id||1),this.cache[s]||(this.cache[s]={}),this.cache[s][n]||(this.cache[s][n]=this.makeVBO(t,e,i,r,a)),this.cache[s][n]}},Magi.Motion={makeBounce:function(){return this.addFrameListener(function(t,e){var i=2*Math.abs(Math.sin(t/500));this.position[1]=i}),this},makeRotate:function(t){return t=t||.2,this.addFrameListener(function(e,i){this.rotation.angle=2*Math.PI*e/(1e3/t)%(2*Math.PI)}),this}},Magi.Node=Klass(Magi.Motion,{model:null,position:null,rotation:null,scaling:null,polygonOffset:null,scaleAfterRotate:!1,depthMask:null,depthTest:null,display:!0,transparent:!1,id:null,parentNode:null,initialize:function(t){this.model=t,this.absolutePosition=vec3.create(),this.renderPasses={normal:!0},this.material=new Magi.Material,this.matrix=mat4.identity(),this.normalMatrix=mat3.identity(),this.rotation={angle:0,axis:vec3.create([0,1,0])},this.position=vec3.create([0,0,0]),this.scaling=vec3.create([1,1,1]),this.frameListeners=[],this.childNodes=[],this.afterTransformListeners=[]},getNodeById:function(t){var e=null;try{this.filterNodes(function(i){if(i.id==t)throw e=i,null})}catch(t){return e}},getNodesById:function(t){return this.filterNodes(function(e){return e.id==t})},getNodesByKlass:function(t){return this.filterNodes(function(e){return e instanceof t})},getNodesByMethod:function(t){return this.filterNodes(function(e){return e[t]})},getNodesByKeyValue:function(t,e){return this.filterNodes(function(i){return i[t]==e})},filterNodes:function(t){var e=[];return this.forEach(function(i){t(i)&&e.push(i)}),e},forEach:function(t){t.call(this,this),this.childNodes.forEach(function(e){e.forEach(t)})},setX:function(t){return this.position[0]=t,this.changed=!0,this},setY:function(t){return this.position[1]=t,this.changed=!0,this},setZ:function(t){return this.position[2]=t,this.changed=!0,this},setPosition:function(t,e,i){return null!=t.length?vec3.set(t,this.position):null==e?vec3.set3(t,this.position):(this.position[0]=t,this.position[1]=e,null!=i&&(this.position[2]=i)),this.changed=!0,this},setScale:function(t,e,i){return null!=t.length?vec3.set(t,this.scaling):null==e?vec3.set3(t,this.scaling):(this.scaling[0]=t,this.scaling[1]=e,null!=i&&(this.scaling[2]=i)),this.changed=!0,this},setAngle:function(t){return this.rotation.angle=t,this.changed=!0,this},setAxis:function(t,e,i){return null!=t.length?vec3.set(t,this.rotation.axis):null==e?vec3.set3(t,this.rotation.axis):(this.rotation.axis[0]=t,this.rotation.axis[1]=e,null!=i&&(this.rotation.axis[2]=i)),this.changed=!0,this},draw:function(t,e,i){if(this.model&&this.display){this.material&&this.material.apply(t,e,i,this.matrix,this.normalMatrix),null==this.model.gl&&(this.model.gl=t);var r=e.blendFuncSrc,a=e.blendFuncDst,n=e.depthMask,s=e.depthTest,o=e.polygonOffset,h=e.blend,l=e.cullFace;if(this.polygonOffset&&t.polygonOffset(this.polygonOffset.factor,this.polygonOffset.units),null!=this.depthMask&&this.depthMask!=e.depthMask&&t.depthMask(this.depthMask),null!=this.depthTest&&this.depthTest!=e.depthTest&&(this.depthTest?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST)),this.blendFuncSrc&&this.blendFuncDst&&t.blendFunc(t[this.blendFuncSrc],t[this.blendFuncDst]),null!=this.blend&&this.blend!=e.blend&&(this.blend?t.enable(t.BLEND):t.disable(t.BLEND)),null!=this.cullFace&&this.cullFace!=e.cullFace&&(t.enable(t.CULL_FACE),t.cullFace(t[this.cullFace])),this.model.attributes){this.model.attributeIdxs||(this.model.attributeIdxs=[]);for(var u=0;u<this.model.attributes.length;u++)this.model.attributeIdxs[u]=e.currentShader.attrib(this.model.attributes[u]);this.model.draw.apply(this.model,this.model.attributeIdxs)}else this.model.draw(e.currentShader.attrib("Vertex"),e.currentShader.attrib("Normal"),e.currentShader.attrib("TexCoord"));null!=this.cullFace&&this.cullFace!=e.cullFace&&(l?t.cullFace(t[l]):t.disable(t.CULL_FACE)),null!=this.blend&&this.blend!=e.blend&&(h?t.enable(t.BLEND):t.disable(t.BLEND)),this.blendFuncSrc&&this.blendFuncDst&&t.blendFunc(t[r],t[a]),null!=this.depthTest&&this.depthTest!=e.depthTest&&(s?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST)),null!=this.depthMask&&this.depthMask!=e.depthMask&&t.depthMask(n),this.polygonOffset&&t.polygonOffset(o.factor,o.units)}},addFrameListener:function(t){this.frameListeners.push(t)},afterTransform:function(t){this.afterTransformListeners.push(t)},update:function(t,e){for(var i=[],r=0;r<this.frameListeners.length;r++)i.push(this.frameListeners[r]);for(r=0;r<i.length;r++)-1!=this.frameListeners.indexOf(i[r])&&i[r].call(this,t,e,this);for(r=0;r<this.childNodes.length;r++)this.childNodes[r].parentNode=this,this.childNodes[r].update(t,e)},appendChild:function(t){this.childNodes.push(t),t.parentNode=this},removeChild:function(t){for(var e=this.childNodes.indexOf(t);-1!=e;)this.childNodes[e].parentNode=null,this.childNodes.splice(e,1),e=this.childNodes.indexOf(t);t.parentNode=null},removeSelf:function(){this.parentNode&&this.parentNode.removeChild(this)},updateTransform:function(t,e,i,r){var a=this.matrix;if(this.changed=this.changed||r,this.changed){mat4.set(t,a);var n=this.position,s=this.scaling,o=1!=s[0]||1!=s[1]||1!=s[2];(n[0]||n[1]||n[2])&&mat4.translate(a,n),this.scaleAfterRotate&&o&&mat4.scale(a,s),0!=this.rotation.angle&&mat4.rotate(a,this.rotation.angle,this.rotation.axis),!this.scaleAfterRotate&&o&&mat4.scale(a,s),this.transform&&mat4.multiply(this.transform,a,a),this.isBillboard&&mat4.billboard(a),mat4.toInverseMat3(a,this.normalMatrix),mat3.transpose(this.normalMatrix),this.absolutePosition[0]=a[12],this.absolutePosition[1]=a[13],this.absolutePosition[2]=a[14]}for(var h=0;h<this.afterTransformListeners.length;h++)this.afterTransformListeners[h].call(this,a,e,i);for(h=0;h<this.childNodes.length;h++)this.childNodes[h].updateTransform(a,e,i,this.changed);this.changed=!1},getWorldPosition:function(t,e){return null==e&&(e=vec3.create()),vec3.sub(this.absolutePosition,t,e)},collectDrawList:function(t){if(t||(t=[]),this.display){t.push(this);for(var e=0;e<this.childNodes.length;e++)this.childNodes[e].collectDrawList(t)}return t}}),Magi.Material=Klass({initialize:function(t){this.shader=t,this.textures={};for(var e in this.textures)delete this.textures[e];this.floats={};for(var e in this.floats)delete this.floats[e];this.ints={};for(var e in this.ints)delete this.ints[e]},copyValue:function(t){if("number"==typeof t)return t;for(var e=new t.__proto__.constructor(t.length),i=0;i<t.length;i++)e[i]=t[i];return e},copy:function(){var t=new Magi.Material;for(var e in this.floats)t.floats[e]=this.copyValue(this.floats[e]);for(var e in this.ints)t.ints[e]=this.copyValue(this.ints[e]);for(var e in this.textures)t.textures[e]=this.textures[e];return t.shader=this.shader,t},apply:function(t,e,i,r,a){var n=this.shader;n&&null==n.gl&&(n.gl=t),e.currentShader!=n&&(n.use(),n.uniformMatrix4fv("PMatrix",i),Magi.Stats.uniformSetCount++,e.currentShader=this.shader,Magi.Stats.shaderBindCount++),e.currentShader.uniformMatrix4fv("MVMatrix",r),e.currentShader.uniformMatrix3fv("NMatrix",a),Magi.Stats.uniformSetCount+=2,e.currentMaterial!=this&&(e.currentMaterial=this,Magi.Stats.materialUpdateCount++,this.applyTextures(t,e),this.applyFloats(),this.applyInts())},applyTextures:function(t,e){var i=0;for(var r in this.textures){var a=this.textures[r];a||(a=Magi.Texture.getDefaultTexture(t)),null==a.gl&&(a.gl=t),e.textures[i]!=a&&(e.textures[i]=a,t.activeTexture(t.TEXTURE0+i),a.use(),Magi.Stats.textureSetCount++),this.shader.uniform1i(r,i),Magi.Stats.uniformSetCount++,++i}},cmp:function(t,e){return t===e||t==e},cloneVec:function(t,e){e&&e.length==t.length||(e=new t.constructor(t.length));for(var i=0;i<t.length;i++)e[i]=t[i];return e},applyFloats:function(){var t=this.shader;for(var e in this.floats){var i=this.floats[e],r=t.uniform(e);if(!this.cmp(r.current,i))if(i.length?r.current=this.cloneVec(i,r.current):r.current=i,Magi.Stats.uniformSetCount++,null==i.length)t.uniform1f(e,i);else switch(i.length){case 4:t.uniform4fv(e,i);break;case 3:t.uniform3fv(e,i);break;case 16:t.uniformMatrix4fv(e,i);break;case 9:t.uniformMatrix3fv(e,i);break;case 2:t.uniform2fv(e,i);break;default:t.uniform1fv(e,i)}}},applyInts:function(){var t=this.shader;for(var e in this.ints){var i=this.ints[e],r=t.uniform(e);if(!this.cmp(r.current,i))if(i.length?r.current=this.cloneVec(i,r.current):r.current=i,Magi.Stats.uniformSetCount++,null==i.length)t.uniform1i(e,i);else switch(i.length){case 4:t.uniform4iv(e,i);break;case 3:t.uniform3iv(e,i);break;case 2:t.uniform2iv(e,i);break;default:t.uniform1iv(e,i)}}}}),Magi.GLDrawState=Klass({textures:null,currentMaterial:null,currentShader:null,polygonOffset:null,blendFuncSrc:"ONE",blendFuncDst:"ONE_MINUS_SRC_ALPHA",depthMask:!0,depthTest:!0,blend:!0,initialize:function(){this.polygonOffset={factor:0,units:0},this.textures=[]}}),Magi.Camera=Klass({fov:30,targetFov:30,zNear:1,zFar:1e4,useLookAt:!0,ortho:!1,stereo:!1,stereoSeparation:.025,renderPass:"normal",blend:!0,blendFuncSrc:"ONE",blendFuncDst:"ONE_MINUS_SRC_ALPHA",useProjectionMatrix:!1,initialize:function(){this.position=vec3.create([0,0,10]),this.lookAt=vec3.create([0,0,0]),this.up=vec3.create([0,1,0]),this.matrix=mat4.create(),this.perspectiveMatrix=mat4.create(),this.frameListeners=[],this.afterTransformListeners=[]},addFrameListener:Magi.Node.prototype.addFrameListener,update:function(t,e){for(var i=[],r=0;r<this.frameListeners.length;r++)i.push(this.frameListeners[r]);for(r=0;r<i.length;r++)-1!=this.frameListeners.indexOf(i[r])&&i[r].call(this,t,e,this);this.targetFov&&this.fov!=this.targetFov&&(this.fov+=(this.targetFov-this.fov)*(1-Math.pow(.7,e/30)))},afterTransform:function(t){this.afterTransformListeners.push(t)},getLookMatrix:function(){return this.useLookAt&&!this.useProjectionMatrix?mat4.lookAt(this.position,this.lookAt,this.up,this.matrix):mat4.identity(this.matrix),this.matrix},moveTo:function(t){var e=vec3.create();vec3.sub(t,this.lookAt,e),vec3.add(this.lookAt,e),vec3.add(this.position,e)},setDistance:function(t){var e=vec3.create();vec3.sub(this.position,this.lookAt,e),vec3.scale(e,t/vec3.length(e)),vec3.add(this.lookAt,e,this.position)},multiplyDistance:function(t){var e=vec3.create();vec3.sub(this.position,this.lookAt,e),vec3.scale(e,t),vec3.add(this.lookAt,e,this.position)},drawViewport:function(t,e,i,r,a,n,s,o){t.enable(t.SCISSOR_TEST),t.viewport(e,i,r,a),t.scissor(e,i,r,a),n.updateTransform(mat4.identity(),s,o);for(var h=0;h<this.afterTransformListeners.length;h++)this.afterTransformListeners[h].call(this,this.perspectiveMatrix,s,o);this.useProjectionMatrix||(this.ortho?mat4.ortho(e,r,-a,-i,this.zNear,this.zFar,this.perspectiveMatrix):mat4.perspective(this.fov,r/a,this.zNear,this.zFar,this.perspectiveMatrix)),mat4.multiply(this.perspectiveMatrix,this.getLookMatrix());var l=new Magi.GLDrawState;this.resetState(t,l);s=new Date;var u=n.collectDrawList(),c=[];for(h=0;h<u.length;h++){(f=u[h]).renderPasses[this.renderPass]&&(f.transparent?c.push(f):f.draw(t,l,this.perspectiveMatrix))}this.normalDrawTime=new Date-s,c.stableSort(function(t,e){return t.matrix[14]-e.matrix[14]});l=new Magi.GLDrawState;this.resetState(t,l),t.depthMask(!1),l.depthMask=!1;for(h=0;h<c.length;h++){var f;(f=c[h]).draw(t,l,this.perspectiveMatrix)}t.depthMask(!0),this.transparentDrawTime=new Date-s-this.normalDrawTime,t.disable(t.SCISSOR_TEST),this.drawTime=new Date-s},resetState:function(t,e){t.depthFunc(t.LESS),t.disable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.enable(t.DEPTH_TEST),e.depthTest=!0,this.blendFuncSrc&&this.blendFuncDst&&(e.blendFuncSrc=this.blendFuncSrc,e.blendFuncDst=this.blendFuncDst,t.blendFunc(t[this.blendFuncSrc],t[this.blendFuncDst])),this.blend?t.enable(t.BLEND):t.disable(t.BLEND),e.blend=this.blend,t.depthMask(!0),e.depthMask=!0},draw:function(t,e,i,r,a,n){if(this.stereo){var s=vec3.create(this.position),o=vec3.create();vec3.subtract(this.lookAt,s,o),vec3.cross(this.up,o,o),vec3.scale(o,this.stereoSeparation/2,o),vec3.subtract(s,o,this.position),this.drawViewport(t,0,0,e/2,i,r,a,n),vec3.add(s,o,this.position),this.drawViewport(t,e/2,0,e/2,i,r,a,n),vec3.set(s,this.position)}else this.drawViewport(t,0,0,e,i,r,a,n)}}),window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,e){window.setTimeout(t,1e3/60)},Magi.Scene=Klass({frameDuration:13,time:0,timeDir:1,timeSpeed:1,previousTime:0,frameTimes:[],fpsCanvas:null,bg:[1,1,1,1],clear:!0,paused:!1,showStats:!1,supersample:1,initialize:function(t,e,i,r){if(e||(e=new Magi.Node),i||(i=Magi.Scene.getDefaultCamera()),"CANVAS"==t.tagName){this.canvas=t;var a={alpha:!0,depth:!0,stencil:!0,antialias:!0,premultipliedAlpha:!0};r&&Object.extend(a,r),this.gl=Magi.getGLContext(t,a)}else this.fbo=t,this.gl=this.fbo.gl;this.idFilter=new Magi.IdFilter,this.postFBO1=new Magi.FBO(this.gl,1,1,!1),this.postFBO2=new Magi.FBO(this.gl,1,1,!1),this.preEffects=[],this.postEffects=[],this.clearBits=this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT|this.gl.STENCIL_BUFFER_BIT,this.scene=e,this.root=e,this.camera=i,this.mouse={x:0,y:0,pressure:1,tiltX:0,tiltY:0,deviceType:0,left:!1,middle:!1,right:!1},this.setupEventListeners(),this.canvas&&this.startFrameLoop()},getDefaultCamera:function(){var t=new Magi.Camera;return vec3.set([0,0,0],t.lookAt),vec3.set([0,0,10],t.position),t.fov=45,t.angle=1,t},animLoop:function(){this.draw();var t=this;requestAnimFrame(function(){t.animLoop()},this.canvas)},startFrameLoop:function(){this.previousTime=new Date;var t=this;requestAnimFrame(function(){t.animLoop()},this.canvas)},updateMouse:function(t){this.mouse.deviceType=t.mozDeviceType||0,this.mouse.tiltX=t.mozTiltX||0,this.mouse.tiltY=t.mozTiltY||0,this.mouse.pressure=t.mozPressure||0,this.mouse.x=t.clientX,this.mouse.y=t.clientY},setupEventListeners:function(){var t=this;window.addEventListener("mousedown",function(e){switch(e.button){case Mouse.LEFT:t.mouse.left=!0;break;case Mouse.RIGHT:t.mouse.right=!0;break;case Mouse.MIDDLE:t.mouse.middle=!0}t.updateMouse(e)},!1),window.addEventListener("mouseup",function(e){switch(e.button){case Mouse.LEFT:t.mouse.left=!1;break;case Mouse.RIGHT:t.mouse.right=!1;break;case Mouse.MIDDLE:t.mouse.middle=!1}t.updateMouse(e)},!1),window.addEventListener("mousemove",function(e){t.updateMouse(e)},!1)},draw:function(t,e){if(!this.paused){t=null==t?new Date:t,e=null==e?t-this.previousTime:e;var i=this.timeDir*this.timeSpeed*e;this.time+=i,this.previousTime=t,this.frameTime=e,this.camera.update(this.time,i),this.scene.update(this.time,i);var r=new Date;if(this.updateTime=r-t,!this.drawOnlyWhenChanged||this.changed){this.canvas?(this.width=this.canvas.width,this.height=this.canvas.height):(this.width=this.fbo.width,this.height=this.fbo.height),this.clear&&(this.gl.depthMask(!0),this.gl.clearColor(this.bg[0],this.bg[1],this.bg[2],this.bg[3]),this.gl.clear(this.clearBits),Magi.throwError(this.gl,"clear")),this.preEffects.length>0&&this.drawEffects(this.fbo,this.preEffects,this.fbo.texture,r,i);var a=this.canvas?this.supersample:1;if(this.camera.draw(this.gl,this.width*a,this.height*a,this.root,r,i),this.drawTime=new Date-r,this.updateFps(this.frameTimes,e),this.firstFrameDoneTime||(this.firstFrameDoneTime=new Date),this.changed=!1,Magi.throwError(this.gl,"Scene draw loop"),this.showStats){var n=E.byId("stats");n&&(Magi.Stats.print(n),Magi.Stats.reset())}}}},drawEffects:function(t,e,i,r,a){if(0!=e.length||i!=t.texture){var n=this.postFBO1,s=this.postFBO2;n.resize(t.width,t.height),s.resize(t.width,t.height);for(var o=0;o<e.length;o++){s.use();var h=e[o];h.material.textures.Texture0=i,i=s.texture,this.camera.draw(this.gl,s.width,s.height,h,r,a);var l=n;n=s,s=l}t.tagName?this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null):t.use(),this.idFilter.material.textures.Texture0=i,this.camera.draw(this.gl,t.width,t.height,this.idFilter)}},updateFps:function(t,e){var i=this.fpsCanvas||document.getElementById("fps");if(i){var r=i.getContext("2d");r.clearRect(0,0,i.width,i.height);var a=i.height;t.push(1e3/(1+e)),t.length>1e3&&t.splice(200);for(var n=Math.max(0,t.length-200),s=n;s<t.length;s++)r.fillRect(s-n,a,1,-t[s]/3)}},useDefaultCameraControls:function(t){var e=this;t=t||this.canvas;var i=new Magi.Node;vec3.set([1,0,0],i.rotation.axis);var r=new Magi.Node;vec3.set([0,1,0],r.rotation.axis),i.appendChild(r),this.root=i,this.yRot=i,this.xRot=r,this.root=this.scene;var a=function(t){var i=t.detail<0||t.wheelDelta>0?.8:1.25;t.shiftKey?e.camera.targetFov*=i:e.camera.multiplyDistance(i),e.changed=!0,t.preventDefault()};e.camera.addFrameListener(function(){Math.abs(this.targetFov-this.fov)>.01&&(e.changed=!0)}),t.addEventListener("DOMMouseScroll",a,!1),t.addEventListener("mousewheel",a,!1),t.addEventListener("mousedown",function(t){e.dragging=!0,e.sx=t.clientX,e.sy=t.clientY,t.preventDefault()},!1),window.addEventListener("mousemove",function(t){if(e.dragging){var a=t.clientX-e.sx,n=t.clientY-e.sy;e.sx=t.clientX,e.sy=t.clientY,e.mouse.left?(r.rotation.angle+=a/200,i.rotation.angle+=n/200):e.mouse.middle&&(i.position[0]+=.01*a*(e.camera.fov/45),i.position[1]-=.01*n*(e.camera.fov/45));var s=r.rotation.angle,o=i.rotation.angle,h=vec3.distance(e.camera.lookAt,e.camera.position),l=vec3.scale(vec3.normalize(vec3.create(Math.cos(s),Math.sin(o),Math.sin(s))),h);vec3.add(l,e.camera.lookAt,e.camera.position),t.preventDefault(),e.changed=!0}},!1),window.addEventListener("mouseup",function(t){e.dragging&&(e.dragging=!1,t.preventDefault())},!1);var n=r.rotation.angle,s=i.rotation.angle,o=vec3.distance(e.camera.lookAt,e.camera.position),h=vec3.scale(vec3.normalize(vec3.create(Math.cos(n),Math.sin(s),Math.sin(n))),o);vec3.add(h,e.camera.lookAt,e.camera.position),e.changed=!0}}),Magi.UberShader=Klass({initialize:function(t,e){this.verts=t,this.frags=e,this.shaderCache=[]},build:function(t,e){var i=[];for(var r in e)i.push("#define "+r+" "+e[r]);i.sort();var a=t.join("")+""+i.join("");if(!this.shaderCache[a]){var n=[],s=[];for(r=0;r<t.length;r++){var o=this.verts[t[r]];o&&n.push(o);var h=this.frags[t[r]];h&&s.push(h)}var l=i.join("\n")+"\n",u=l+n.join("\n"),c=l+s.join("\n"),f=new Magi.Shader(null,{type:"VERTEX_SHADER",text:u},{type:"FRAGMENT_SHADER",text:c});this.shaderCache[a]=f}return this.shaderCache[a]}}),Magi.Cube=Klass(Magi.Node,{initialize:function(){Magi.Node.initialize.call(this,Magi.Geometry.Cube.getCachedVBO()),this.material=Magi.DefaultMaterial.get()}}),Magi.CubeArray=Klass(Magi.Node,{initialize:function(){Magi.Node.initialize.call(this,Magi.Geometry.CubeArray.getCachedVBO()),this.material=Magi.DefaultMaterial.get()}}),Magi.Ring=Klass(Magi.Node,{initialize:function(t,e,i,r){Magi.Node.initialize.call(this,Magi.Geometry.Ring.getCachedVBO(null,t,i,r,e)),this.material=Magi.DefaultMaterial.get()}}),Magi.Sphere=Klass(Magi.Node,{initialize:function(t,e,i){Magi.Node.initialize.call(this,Magi.Geometry.Sphere.getCachedVBO(null,t,e,i)),this.material=Magi.DefaultMaterial.get()}}),Magi.Disk=Klass(Magi.Node,{initialize:function(t,e,i,r,a){Magi.Node.initialize.call(this,Magi.Geometry.Disk.getCachedVBO(null,t,e,i,r,a)),this.material=Magi.DefaultMaterial.get()}}),Magi.Quad=Klass(Magi.Node,{initialize:function(t){Magi.Node.initialize.call(this,Magi.Geometry.Quad.getCachedVBO()),this.material=Magi.DefaultMaterial.get()}}),Magi.FilterQuad=Klass(Magi.Node,{identityTransform:!0,depthMask:!1,initialize:function(t){Magi.Node.initialize.call(this,Magi.Geometry.Quad.getCachedVBO()),this.material=Magi.FilterQuadMaterial.make(null,t)}}),Magi.FlipFilterQuad=Klass(Magi.Node,{identityTransform:!0,depthMask:!1,initialize:function(t){Magi.Node.initialize.call(this,Magi.Geometry.Quad.getCachedVBO()),this.material=Magi.FlipFilterQuadMaterial.make(null,t)}}),Magi.ColorFilterQuad=Klass(Magi.Node,{initialize:function(t,e,i,r){Magi.Node.initialize.call(this,Magi.Geometry.Quad.getCachedVBO()),this.material=Magi.ColorQuadMaterial.get(null),this.transparent=this.a<1,this.material.floats.Color=vec4.create([t,e,i,r])}}),Magi.ColorQuad=Klass(Magi.Node,{initialize:function(t,e,i,r){Magi.Node.initialize.call(this,Magi.Geometry.Quad.getCachedVBO()),this.material=Magi.ColorMaterial.get(null),this.transparent=this.a<1,this.material.floats.Color=vec4.create([t,e,i,r])}}),Magi.RadialGlowFilter=Klass(Magi.FilterQuad,{initialize:function(){Magi.FilterQuad.initialize.call(this),this.material=Magi.RadialGlowMaterial.get()}}),Magi.FlipRadialGlowFilter=Klass(Magi.FilterQuad,{initialize:function(){Magi.FilterQuad.initialize.call(this),this.material=Magi.FlipRadialGlowMaterial.get()}}),Magi.IdFilter=Klass(Magi.FilterQuad,{initialize:function(){Magi.FilterQuad.initialize.call(this),this.material=Magi.IdFilterMaterial.get()}}),Magi.Alignable={leftAlign:1,rightAlign:-1,topAlign:-1,bottomAlign:1,centerAlign:0,align:0,valign:0,alignQuad:function(t,e,i){t.position[0]=this.align*e/2,t.position[1]=this.valign*i/2},updateAlign:function(){this.alignQuad(this.alignedNode,this.width,this.height)},setAlign:function(t,e){return this.align=t,null!=e&&(this.valign=e),this.updateAlign(),this},setVAlign:function(t){return this.valign=t,this.updateAlign(),this}},Magi.Image=Klass(Magi.Node,Magi.Alignable,{initialize:function(t,e){Magi.Node.initialize.call(this),this.alignedNode=new Magi.Node(Magi.Geometry.Quad.getCachedVBO()),this.alignedNode.material=e?Magi.FlipFilterMaterial.get():Magi.FilterMaterial.get(),this.alignedNode.transparent=!0,this.alignedNode.blendFuncSrc="SRC_ALPHA",this.alignedNode.blendFuncDst="ONE_MINUS_SRC_ALPHA",this.appendChild(this.alignedNode),this.setTexture(new Magi.Texture),this.texture.generateMipmaps=!1,t&&this.setImage(t)},setTexture:function(t){return t!=this.texture&&(this.texture&&this.texture.destroy(),this.texture=t,this.alignedNode.material.textures.Texture0=this.texture),this},setSize:function(t){return this.size=t,this.image&&this.image.tagName&&Object.isImageLoaded(this.image)&&this.reposition(),this},reposition:function(){var t=this.image.width,e=this.image.height;if(null!=this.size){var i=Math.min(this.size/t,this.size/e);t*=i,e*=i}this.width=t,this.height=e,this.alignedNode.scaling[0]=t/2,this.alignedNode.scaling[1]=e/2,this.updateAlign()},setImage:function(t){var e=t;if("string"==typeof t&&((e=new Image).src=t),this.image&&this.image.__imageLoadHandler&&this.image.removeEventListener("load",this.image.__imageLoadHandler,!1),this.image=e,e.tagName&&!Object.isImageLoaded(e)){var i=this;e.__imageLoadHandler=function(){i.image==this&&i.setImage(this)},e.addEventListener("load",e.__imageLoadHandler,!1)}return this.image.width,this.reposition(),this.image instanceof Magi.Texture?this.setTexture(this.image):(this.texture.image=this.image,this.texture.changed=!0),this}}),Magi.Text=Klass(Magi.Image,Magi.Alignable,{fontSize:24,font:"Arial",color:"black",initialize:function(t,e,i,r,a){this.canvas=E.canvas(1,1),Magi.Image.initialize.call(this,this.canvas),this.texture.generateMipmaps=a,e&&(this.fontSize=e),r&&(this.font=r),i&&(this.color=i),this.setText(t)},setText:function(t){this.text=t;var e=this.canvas.getContext("2d"),i=this.fontSize+"px "+this.font;e.font=i;var r=e.measureText(t),a=Math.max(1,Math.min(2048,r.width)),n=Math.max(1,Math.min(2048,Math.ceil(1.25*this.fontSize)));if(this.realWidth=a,this.realHeight=n,this.texture.generateMipmaps){var s=Math.log(a)/Math.log(2);a=Math.pow(2,Math.ceil(s));var o=Math.log(n)/Math.log(2);n=Math.pow(2,Math.ceil(o))}return this.canvas.width=a,this.canvas.height=n,(e=this.canvas.getContext("2d")).font=i,e.clearRect(0,0,this.canvas.width,this.canvas.height),e.fillStyle=this.color,e.fillText(this.text,0,this.fontSize),this.setImage(this.canvas),this},setFontSize:function(t){return this.fontSize=t,this.setText(this.text),this},setFont:function(t){return this.font=t,this.setText(this.text),this},setColor:function(t){return this.color=t,this.setText(this.text),this}}),Magi.MeshText=Klass(Magi.Text,{initialize:function(t,e,i,r){Magi.Text.initialize.apply(this,arguments),this.alignedNode.model=Magi.Geometry.QuadMesh.getCachedVBO(null,20,100)}}),Magi.MeshImage=Klass(Magi.Image,{initialize:function(t){Magi.Image.initialize.apply(this,arguments),this.alignedNode.model=Magi.Geometry.QuadMesh.getCachedVBO()}}),Magi.CubeText=Klass(Magi.Text,{initialize:function(t,e,i,r){Magi.Text.initialize.apply(this,arguments),this.alignedNode.model=Magi.Geometry.CubeArray.getCachedVBO(null,200,24),this.alignedNode.material=Magi.CubeArrayMaterial.get(),this.alignedNode.material.textures.Texture0=this.texture},setText:function(t){return Magi.Text.setText.apply(this,arguments),this.alignedNode.material.floats.width=this.width,this.alignedNode.material.floats.height=this.height,this}}),Magi.ShaderLib={defaultTransform:"precision highp float;attribute vec3 Vertex;attribute vec2 TexCoord;uniform mat4 PMatrix;uniform mat4 MVMatrix;uniform mat3 NMatrix;varying vec2 texCoord0;vec4 transform(){  vec4 v = vec4(Vertex, 1.0);  vec4 worldPos = MVMatrix * v;  return PMatrix * worldPos;}vec2 texCoord(){ return TexCoord.st; }vec2 flipTexCoord(){ return vec2(TexCoord.s, 1.0-TexCoord.t); }void defaultTransform(){  gl_Position = transform();  texCoord0 = texCoord();}void defaultImageTransform(){  gl_Position = transform();  texCoord0 = flipTexCoord();}"},Magi.FilterMaterial={vert:{type:"VERTEX_SHADER",text:Magi.ShaderLib.defaultTransform+"void main(){  defaultImageTransform();}"},frag:{type:"FRAGMENT_SHADER",text:"precision highp float;uniform sampler2D Texture0;uniform float offsetY;uniform float offsetX;uniform float opacity;varying vec2 texCoord0;void main(){  vec2 v = vec2(texCoord0.s/(1.0-offsetX), texCoord0.t/(1.0-offsetY));  vec4 c = texture2D(Texture0, v);  c.a *= opacity;  if (v.s < 0.0 || v.s > 1.0 || v.t < 0.0 || v.t > 1.0) c = vec4(0.0);  gl_FragColor = c*c.a;}"},make:function(t,e){var i=new Magi.Filter(null,this.vert,e||this.frag);return this.setupMaterial(i)},get:function(t){return this.cached||(this.cached=this.make(t)),this.cached.copy()},setupMaterial:function(t){var e=new Magi.Material(t);return e.textures.Texture0=null,e.floats.opacity=1,e}},Magi.FlipFilterMaterial=Object.clone(Magi.FilterMaterial),Magi.FlipFilterMaterial.vert={type:"VERTEX_SHADER",text:Magi.ShaderLib.defaultTransform+"void main(){  defaultTransform();}"},Magi.FilterQuadMaterial=Object.clone(Magi.FilterMaterial),Magi.FilterQuadMaterial.vert={type:"VERTEX_SHADER",text:Magi.ShaderLib.defaultTransform+"void main(){  vec4 v = vec4(Vertex, 1.0);  texCoord0 = texCoord();  gl_Position = v;}"},Magi.FlipFilterQuadMaterial=Object.clone(Magi.FilterMaterial),Magi.FlipFilterQuadMaterial.vert={type:"VERTEX_SHADER",text:Magi.ShaderLib.defaultTransform+"void main(){  vec4 v = vec4(Vertex, 1.0);  texCoord0 = flipTexCoord();  gl_Position = v;}"},Magi.IdFilterMaterial=Object.clone(Magi.FilterQuadMaterial),Magi.IdFilterMaterial.frag={type:"FRAGMENT_SHADER",text:"precision highp float;uniform sampler2D Texture0;varying vec2 texCoord0;void main(){  vec4 c = texture2D(Texture0, texCoord0);  gl_FragColor = c;}"},Magi.RadialGlowMaterial=Object.clone(Magi.FilterQuadMaterial),Magi.RadialGlowMaterial.frag={type:"FRAGMENT_SHADER",text:"precision highp float;uniform sampler2D Texture0;varying vec2 texCoord0;uniform vec2 center;uniform float radius;uniform float currentFactor;uniform float intensity;uniform float falloff;void main(){  float samples = 15.0;  float len = length(center - texCoord0);  float rs = min(len,radius)/samples;  vec2 dir = rs * normalize(center - texCoord0);  vec4 c = currentFactor * texture2D(Texture0, texCoord0);  float d = intensity/10.0;  for (float r=1.0; r <= samples; r++) {    vec2 tc = texCoord0 + (r*dir);    vec4 pc = texture2D(Texture0, tc + rs);    c += pc*d;    d *= falloff;  }  gl_FragColor = c*c.a;}"},Magi.RadialGlowMaterial.setupMaterial=function(t){var e=new Magi.Material(t);return e.textures.Texture0=null,e.floats.center=vec2.create(.5,.5),e.floats.radius=.034,e.floats.intensity=1,e.floats.falloff=.9,e.floats.currentFactor=1,e},Magi.FlipRadialGlowMaterial=Object.clone(Magi.RadialGlowMaterial),Magi.FlipRadialGlowMaterial.vert=Magi.FlipFilterQuadMaterial.vert,Magi.CubeArrayMaterial=Object.clone(Magi.FilterMaterial),Magi.CubeArrayMaterial.vert={type:"VERTEX_SHADER",text:Magi.ShaderLib.defaultTransform+"uniform float width;uniform float height;varying vec2 texCoord0;float grid(float c, float sz){  return (0.5+floor(c*sz))/sz;}void main(){  texCoord0 = vec2(grid(TexCoord.s, width), grid(1.0-TexCoord.t, height));  if (texture2D(Texture0, texCoord0).a == 0.0) {    gl_Position = vec4(-3.0, -3.0, -3.0, 1.0);  } else {    gl_Position = transform();  }}"},Magi.ColorQuadMaterial=Object.clone(Magi.FilterMaterial),Magi.ColorQuadMaterial.vert={type:"VERTEX_SHADER",text:Magi.ShaderLib.defaultTransform+"void main(){  vec4 v = vec4(Vertex, 1.0);  gl_Position = v;}"},Magi.ColorQuadMaterial.frag={type:"FRAGMENT_SHADER",text:"precision highp float;uniform vec4 Color;void main(){  gl_FragColor = Color;}"},Magi.ColorMaterial=Object.clone(Magi.FilterMaterial),Magi.ColorMaterial.vert={type:"VERTEX_SHADER",text:Magi.ShaderLib.defaultTransform+"void main(){  gl_Position = transform();}"},Magi.ColorMaterial.frag={type:"FRAGMENT_SHADER",text:"precision highp float;uniform vec4 Color;void main(){  gl_FragColor = Color;}"},Magi.DefaultMaterial={vert:{type:"VERTEX_SHADER",text:"precision highp float;attribute vec3 Vertex;attribute vec3 Normal;attribute vec2 TexCoord;uniform mat4 PMatrix;uniform mat4 MVMatrix;uniform mat4 LightMatrix;uniform mat3 NMatrix;uniform float LightConstantAtt;uniform float LightLinearAtt;uniform float LightQuadraticAtt;uniform vec4 LightPos;varying vec3 normal, lightDir, eyeVec;varying vec2 texCoord0;varying float attenuation;void main(){  vec3 lightVector;  vec4 v = vec4(Vertex, 1.0);  texCoord0 = vec2(TexCoord.s, 1.0-TexCoord.t);  normal = normalize(NMatrix * Normal);  vec4 worldPos = MVMatrix * v;  vec4 lightWorldPos = LightMatrix * LightPos;  lightVector = vec3(lightWorldPos - worldPos);  lightDir = normalize(lightVector);  float dist = length(lightVector);  eyeVec = -vec3(worldPos);  attenuation = 1.0 / (1.0 + LightConstantAtt + LightLinearAtt*dist + LightQuadraticAtt * dist*dist);  gl_Position = PMatrix * worldPos;}"},frag:{type:"FRAGMENT_SHADER",text:"precision highp float;uniform vec4 LightDiffuse;uniform vec4 LightSpecular;uniform vec4 LightAmbient;uniform vec4 MaterialSpecular;uniform vec4 MaterialDiffuse;uniform vec4 MaterialAmbient;uniform vec4 MaterialEmit;uniform vec4 GlobalAmbient;uniform float MaterialShininess;uniform sampler2D DiffTex, SpecTex, EmitTex;varying vec3 normal, lightDir, eyeVec;varying vec2 texCoord0;varying float attenuation;void main(){  vec4 color = GlobalAmbient * LightAmbient * MaterialAmbient;  vec4 matDiff = MaterialDiffuse + texture2D(DiffTex, texCoord0);  matDiff.a = 1.0 - (1.0-MaterialDiffuse.a) * (1.0-texture2D(DiffTex, texCoord0).a);  vec4 matSpec = MaterialSpecular + texture2D(SpecTex, texCoord0);  matSpec.a = 1.0 - (1.0-MaterialSpecular.a) * (1.0-texture2D(SpecTex, texCoord0).a);  vec4 diffuse = LightDiffuse * matDiff;  float lambertTerm = dot(normal, lightDir);  vec4 lcolor = diffuse * lambertTerm * attenuation;  vec3 E = normalize(eyeVec);  vec3 R = reflect(-lightDir, normal);  float specular = pow( max(dot(R, E), 0.0), MaterialShininess );  lcolor += matSpec * LightSpecular * specular * attenuation;  if (lambertTerm > 0.0) color += lcolor * lambertTerm;  else color += diffuse * attenuation * MaterialAmbient.a * -lambertTerm;  color += MaterialEmit + texture2D(EmitTex, texCoord0);  color *= matDiff.a;  color.a = matDiff.a;  gl_FragColor = color;}"},get:function(t){if(!this.cached){var e=new Magi.Shader(null,this.vert,this.frag);this.cached=this.setupMaterial(e)}var i=this.cached.copy();return i.floats.LightMatrix=this.lightMatrix,i},lightMatrix:mat4.identity(),setupMaterial:function(t){var e=new Magi.Material(t);return e.textures.DiffTex=e.textures.SpecTex=e.textures.EmitTex=null,e.floats.MaterialSpecular=vec4.create([1,1,1,0]),e.floats.MaterialDiffuse=vec4.create([.5,.5,.5,1]),e.floats.MaterialAmbient=vec4.create([1,1,1,.3]),e.floats.MaterialEmit=vec4.create([0,0,0,0]),e.floats.MaterialShininess=1.5,e.floats.LightMatrix=this.lightMatrix,e.floats.LightPos=vec4.create([1,1,1,1]),e.floats.GlobalAmbient=vec4.create([1,1,1,1]),e.floats.LightSpecular=vec4.create([.8,.8,.95,1]),e.floats.LightDiffuse=vec4.create([.7,.6,.9,1]),e.floats.LightAmbient=vec4.create([.1,.1,.2,1]),e.floats.LightConstantAtt=0,e.floats.LightLinearAtt=0,e.floats.LightQuadraticAtt=0,e}},Magi.MultiMaterial={frag:{type:Magi.DefaultMaterial.frag.type,text:Magi.DefaultMaterial.frag.text.replace(/uniform (\S+ Material)/g,"varying $1")},vert:{type:"VERTEX_SHADER",text:"#define MAX_MATERIALS 4\nprecision highp float;precision highp int;struct material {  vec4 diffuse; vec4 specular; vec4 ambient; vec4 emit; float shininess;};attribute vec3 Vertex;attribute vec3 Normal;attribute vec2 TexCoord;attribute float MaterialIndex;uniform mat4 PMatrix;uniform mat4 MVMatrix;uniform mat4 LightMatrix;uniform mat3 NMatrix;uniform float LightConstantAtt;uniform float LightLinearAtt;uniform float LightQuadraticAtt;uniform vec4 LightPos;uniform material Material0;uniform material Material1;uniform material Material2;uniform material Material3;varying vec3 normal, lightDir, eyeVec;varying vec2 texCoord0;varying float attenuation;varying vec4 MaterialDiffuse;varying vec4 MaterialSpecular;varying vec4 MaterialAmbient;varying vec4 MaterialEmit;varying float MaterialShininess;void main(){  vec3 lightVector;  vec4 v = vec4(Vertex, 1.0);  texCoord0 = vec2(TexCoord.s, 1.0-TexCoord.t);  normal = normalize(NMatrix * Normal);  vec4 worldPos = MVMatrix * v;  vec4 lightWorldPos = LightMatrix * LightPos;  lightVector = vec3(lightWorldPos - worldPos);  lightDir = normalize(lightVector);  float dist = length(lightVector);  eyeVec = normalize(-vec3(worldPos));  attenuation = 1.0 / (1.0 + LightConstantAtt + LightLinearAtt*dist + LightQuadraticAtt * dist*dist);  gl_Position = PMatrix * worldPos;  float midx = MaterialIndex;  material mat = Material3;  if (midx == 0.0) mat = Material0;  if (midx == 1.0) mat = Material1;  if (midx == 2.0) mat = Material2;  MaterialDiffuse = mat.diffuse;  MaterialSpecular = mat.specular;  MaterialAmbient = mat.ambient;  MaterialEmit = mat.emit;  MaterialShininess = mat.shininess;}"},get:function(t){if(!this.cached){var e=new Magi.Shader(null,this.vert,this.frag);this.cached=this.setupMaterial(e)}var i=this.cached.copy();return i.floats.LightMatrix=this.lightMatrix,i},lightMatrix:mat4.identity(),setupMaterial:function(t){var e=new Magi.Material(t);return e.textures.DiffTex=e.textures.SpecTex=e.textures.EmitTex=null,e.floats.LightMatrix=this.lightMatrix,e.floats.LightPos=vec4.create([1,1,1,1]),e.floats.GlobalAmbient=vec4.create([1,1,1,1]),e.floats.LightSpecular=vec4.create([1,1,1,1]),e.floats.LightDiffuse=vec4.create([1,1,1,1]),e.floats.LightAmbient=vec4.create([.1,.1,.1,1]),e.floats.LightConstantAtt=0,e.floats.LightLinearAtt=0,e.floats.LightQuadraticAtt=0,e}},Magi.Tar=function(){},Magi.Tar.load=function(t,e,i,r){var a=new Magi.Tar;return a.onload=e,a.onerror=r,a.onstream=i,a.load(t),a},Magi.Tar.loadGZip=function(t,e,i,r){var a=new Magi.Tar;return a.onload=e,a.onerror=r,a.onstream=i,a.loadGZip(t),a},Magi.Tar.stream=function(t,e,i,r){var a=new Magi.Tar;return a.onload=i,a.onerror=r,a.onstream=e,a.load(t),a},Magi.Tar.streamGZip=function(t,e,i,r){var a=new Tar;return a.onload=i,a.onerror=r,a.onstream=e,a.loadGZip(t),a},Magi.Tar.prototype={onerror:null,onload:null,onstream:null,ondata:null,cleanupAfterLoad:!0,initLoad:function(){this.byteOffset=0,this.parseTime=0,this.files={},this.fileArray=[]},onloadHandler:function(t){this.byteOffset=this.processTarChunks(t.data,this.byteOffset,t.outputSize),this.cleanUpAfterLoad&&t.cleanup(),this.onload&&this.onload(this.files)},onprogressHandler:function(t){this.gzip=t,this.ondata&&this.ondata(t),this.byteOffset=this.processTarChunks(t.data,this.byteOffset,t.outputSize)},onerrorHandler:function(t,e,i){this.onerror&&this.onerror(t,e,i)},loadGZip:function(t){this.initLoad();var e=this;GZip.load(t,function(t){e.onloadHandler(t)},function(t){e.onprogressHandler(t)},function(t,i,r){e.onerrorHandler(t,i,r)})},load:function(t){var e=new XMLHttpRequest;this.initLoad();var i=this,r={data:[],inputSize:0,outputSize:0,offset:0,xhr:e,cleanup:function(){delete this.data,delete this.xhr}};e.onload=function(){r.data[0]=this.responseText,r.inputSize=r.outputSize=r.offset=r.data[0].length;try{i.onloadHandler(r)}catch(t){if(!i.onerror)throw t;i.onerror(this,t,r)}},e.onprogress=function(){r.data[0]=this.responseText,r.inputSize=r.outputSize=r.offset=r.data[0].length,i.onprogressHandler(r)},e.open("GET",t,!0),e.overrideMimeType("text/plain; charset=x-user-defined"),e.setRequestHeader("Content-Type","text/plain"),e.send(null)},cleanHighByte:function(t){return t.replace(/./g,function(t){return String.fromCharCode(255&t.charCodeAt(0))})},parseTar:function(t){this.initLoad(),this.processTarChunks([t],0,t.length)},processTarChunks:function(t,e,i){for(var r=new Date;i>=e+512;){if((a=0==this.fileArray.length?null:this.fileArray[this.fileArray.length-1])&&null==a.data){if(!(e+a.length<=i))break;a.data=this.chunkSubstring(t,e,e+a.length),a.toDataURL=this.__toDataURL,e+=512*Math.ceil(a.length/512),this.onstream&&this.onstream(a,this.gzip)}else{var a,n=this.chunkSubstring(t,e,e+512);(a=this.parseTarHeader(n,0)).length>0||""!=a.filename?(this.fileArray.push(a),this.files[a.filename]=a,e+=512,a.offset=e):e=i}}return this.parseTime+=new Date-r,e},parseTarHeader:function(t,e){var i=e||0,r={};return r.filename=this.parseTarField(t,i,i+=100),r.mode=this.parseTarNumber(t,i,i+=8),r.uid=this.parseTarNumber(t,i,i+=8),r.gid=this.parseTarNumber(t,i,i+=8),r.length=this.parseTarNumber(t,i,i+=12),r.lastModified=this.parseTarNumber(t,i,i+=12),r.checkSum=this.parseTarField(t,i,i+=8),r.fileType=this.parseTarField(t,i,i+=1),r.linkName=this.parseTarField(t,i,i+=100),r.ustar=this.parseTarField(t,i,i+=6),r.ustarVersion=this.parseTarField(t,i,i+=2),r.userName=this.parseTarField(t,i,i+=32),r.groupName=this.parseTarField(t,i,i+=32),r.deviceMajor=this.parseTarField(t,i,i+=8),r.deviceMinor=this.parseTarField(t,i,i+=8),r.filenamePrefix=this.parseTarField(t,i,i+=155),r},parseTarField:function(t,e,i){return t.substring(e,i).split("\0",1)[0]},parseTarNumber:function(t,e,i){var r=t.substring(e,i);return parseInt("0"+r.replace(/[^\d]+/g,""))},chunkSubstring:function(t,e,i){var r=0,a=0,n=0,s=0;for(n=0;n<t.length&&!(r+t[n].length>e);n++)r+=t[n].length;var o=[];for(a=r,s=n;s<t.length&&(o.push(t[s]),!(a+t[s].length>i));s++)a+=t[s].length;return o.join("").substring(e-r,e-r+(i-e))},__toDataURL:function(){if(this.data.substring(0,40).match(/^data:[^\/]+\/[^,]+,/))return this.data;if(Magi.Tar.prototype.cleanHighByte(this.data.substring(0,10)).match(/\377\330\377\340..JFIF/))return"data:image/jpeg;base64,"+btoa(Magi.Tar.prototype.cleanHighByte(this.data));if("PNG\r\n"==Magi.Tar.prototype.cleanHighByte(this.data.substring(0,6)))return"data:image/png;base64,"+btoa(Magi.Tar.prototype.cleanHighByte(this.data));if(Magi.Tar.prototype.cleanHighByte(this.data.substring(0,6)).match(/GIF8[79]a/))return"data:image/gif;base64,"+btoa(Magi.Tar.prototype.cleanHighByte(this.data));throw"toDataURL: I don't know how to handle "+this.filename}},Magi.Obj=function(){},Magi.Obj.load=function(t){var e=new Magi.Obj;return e.load(t),e},Magi.Obj.prototype={load:function(t){var e=new XMLHttpRequest,i=this;i.loadStartTime=new Date,e.onreadystatechange=function(){4==e.readyState&&(200==e.status||0==e.status?(i.downloadTime=new Date-i.loadStartTime,i.parse(e.responseText),i.onload&&i.onload(e)):i.onerror&&i.onerror(e))},e.open("GET",t,!0),e.overrideMimeType("text/plain; charset=x-user-defined"),e.setRequestHeader("Content-Type","text/plain"),e.send(null)},onerror:function(t){alert("Error: "+t.status)},makeVBO:function(t){return this.texcoords?new Magi.VBO(t,{size:3,data:this.vertices},{size:3,data:this.normals},{size:2,data:this.texcoords}):new Magi.VBO(t,{size:3,data:this.vertices},{size:3,data:this.normals})},cache:{},getCachedVBO:function(t){var e=0;return t&&(e=t.id||1),this.cache[e]||(this.cache[e]=this.makeVBO(t)),this.cache[e]},parse:function(t){for(var e=new Date,i=[],r=[],a=[],n=[],s=[],o=[],h=t.split("\n"),l="#".charCodeAt(0),u=0;u<h.length;u++){var c=h[u].replace(/^\s+|\s+$/g,"").split(" ");if(0!=c.length&&c[0].charCodeAt(0)!=l)switch(c[0]){case"g":break;case"v":n.push(parseFloat(c[1])),n.push(parseFloat(c[2])),n.push(parseFloat(c[3]));break;case"vn":s.push(parseFloat(c[1])),s.push(parseFloat(c[2])),s.push(parseFloat(c[3]));break;case"vt":o.push(parseFloat(c[1])),o.push(parseFloat(c[2]));break;case"f":for(var f,d=[],g=1;g<c.length;g++)g>3&&(d.push(d[0]),d.push(f)),f=c[g],d.push(f);for(g=0;g<d.length;g++){var m=d[g].split("/");i.push(parseInt(m[0])-1),m.length>1&&a.push(parseInt(m[1])-1),m.length>2&&r.push(parseInt(m[2])-1)}}}this.vertices=this.lookup_faces(n,i,3),a.length>0&&(this.texcoords=this.lookup_faces(o,a,2)),r.length>0&&!this.overrideNormals?this.normals=this.lookup_faces(s,r,3):this.normals=this.calculate_normals(this.vertices);var p={min:[0,0,0],max:[0,0,0]};for(u=0;u<n.length;u+=3){var v=n[u],M=n[u+1],x=n[u+2];v<p.min[0]?p.min[0]=v:v>p.max[0]&&(p.max[0]=v),M<p.min[1]?p.min[1]=M:M>p.max[1]&&(p.max[1]=M),x<p.min[2]?p.min[2]=x:x>p.max[2]&&(p.max[2]=x)}p.width=p.max[0]-p.min[0],p.height=p.max[1]-p.min[1],p.depth=p.max[2]-p.min[2],p.diameter=Math.max(p.width,p.height,p.depth),this.boundingBox=p,this.parseTime=new Date-e},lookup_faces:function(t,e,i){for(var r=[],a=0;a<e.length;a++)for(var n=e[a]*i,s=0;s<i;s++)r.push(t[n+s]);return r},calculate_normals:function(t){for(var e=[],i=0;i<t.length;i+=9)for(var r=this.find_normal(t[i],t[i+1],t[i+2],t[i+3],t[i+4],t[i+5],t[i+6],t[i+7],t[i+8]),a=0;a<3;a++)e.push(r[0]),e.push(r[1]),e.push(r[2]);return e},find_normal:function(t,e,i,r,a,n,s,o,h){var l=[t-r,e-a,i-n],u=[r-s,a-o,n-h],c=[s-t,o-e,h-i],f=Vec3.cross(l,u);return 0==Vec3.lengthSquare(f)&&(f=Vec3.cross(u,c)),0==Vec3.lengthSquare(f)&&(f=Vec3.cross(c,l)),0==Vec3.lengthSquare(f)&&(f=[0,0,1]),Vec3.normalize(f)}},Magi.Bin=function(){},Magi.Bin.load=function(t,e,i){var r=new Magi.Bin;return e&&(r.onload=e),i&&(r.onerror=i),r.load(t),r},Magi.Bin.prototype={load:function(t){var e=new XMLHttpRequest,i=this;i.loadStartTime=new Date,e.onreadystatechange=function(){4==e.readyState&&(200==e.status||0==e.status?(i.downloadTime=new Date-i.loadStartTime,i.parse(e.responseText),i.onload&&i.onload(i,e)):i.onerror&&i.onerror(e))},e.open("GET",t,!0),e.overrideMimeType("text/plain; charset=x-user-defined"),e.setRequestHeader("Content-Type","text/plain"),e.send(null)},onerror:function(t){alert("Error: "+t.status)},makeVBO:function(t){return this.texcoords?new Magi.VBO(t,{size:3,data:this.vertices},{size:3,data:this.normals},{size:2,data:this.texcoords}):new Magi.VBO(t,{size:3,data:this.vertices},{size:3,data:this.normals})},cache:{},getCachedVBO:function(t){var e=0;return t&&(e=t.id||1),this.cache[e]||(this.cache[e]=this.makeVBO(t)),this.cache[e]},readFloat32:function(t,e){var i=255&t.charCodeAt(e),r=255&t.charCodeAt(e+1),a=(i<<1&255|r>>7)-127,n=(127&r)<<16|(255&t.charCodeAt(e+2))<<8|255&t.charCodeAt(e+3);return 0==n&&-127==a?0:(1-2*(i>>7))*(1+n*Math.pow(2,-23))*Math.pow(2,a)},readUInt32:function(t,e){return((255&t.charCodeAt(e))<<24)+((255&t.charCodeAt(e+1))<<16)+((255&t.charCodeAt(e+2))<<8)+(255&t.charCodeAt(e+3))},readUInt16:function(t,e){return((255&t.charCodeAt(e))<<8)+(255&t.charCodeAt(e+1))},readNormalizedFixedPoint16:function(t,e){return 2*(this.readUInt16(t,e)/65535-.5)},readNormalizedUFixedPoint16:function(t,e){return this.readUInt16(t,e)/65535},readVerts:function(t,e,i,r){for(var a=e+3*r*2;e<a;e+=2)i.push(this.readNormalizedFixedPoint16(t,e));return e},readTexVerts:function(t,e,i,r){for(var a=e+2*r*2;e<a;e+=2)i.push(this.readNormalizedUFixedPoint16(t,e));return e},readTris:function(t,e,i,r,a){for(var n=[],s=e+4*r*2;e<s;e+=2)n.push(this.readUInt16(t,e));for(s=e+3*a*2;e<s;e+=2)i.push(this.readUInt16(t,e));for(var o=0;o<n.length;o+=4)i.push(n[o]),i.push(n[o+1]),i.push(n[o+2]),i.push(n[o]),i.push(n[o+2]),i.push(n[o+3]);return e},translateAndScaleVertices:function(t,e,i,r,a,n,s){e*=.5,i*=.5,r*=.5;for(var o=0;o<t.length;o+=3)t[o]=a+e*(t[o]+1),t[o+1]=n+i*(t[o+1]+1),t[o+2]=s+r*(t[o+2]+1)},parse:function(t){var e=new Date,i=[],r=[],a=[],n=[],s=[],o=[],h=0,l=this.readUInt32(t,h);h+=4;var u=this.readUInt32(t,h);h+=4;var c=this.readUInt32(t,h);h+=4;var f=this.readUInt32(t,h);h+=4;var d=this.readUInt32(t,h);h+=4;var g=this.readFloat32(t,h);h+=4;var m=this.readFloat32(t,h);h+=4;var p=this.readFloat32(t,h);h+=4;var v=this.readFloat32(t,h);h+=4;var M=this.readFloat32(t,h);h+=4;var x=this.readFloat32(t,h);h+=4,h=this.readVerts(t,h,n,l),this.translateAndScaleVertices(n,g,m,p,v,M,x),h=this.readTris(t,h,i,f,d),u>0&&(h=this.readTexVerts(t,h,o,u),h=this.readTris(t,h,r,f,d)),c>0&&(h=this.readVerts(t,h,s,c),h=this.readTris(t,h,a,f,d)),this.vertices=this.lookup_faces(n,i,3),r.length>0&&!this.noTexCoords&&(this.texcoords=this.lookup_faces(o,r,2)),a.length>0&&!this.overrideNormals?this.normals=this.lookup_faces(s,a,3):this.normals=this.calculate_normals(this.vertices,i,this.flatNormals),this.boundingBox=this.calculateBoundingBox(n),this.parseTime=new Date-e},calculateBoundingBox:function(t){for(var e={min:[0,0,0],max:[0,0,0]},i=0;i<t.length;i+=3){var r=t[i],a=t[i+1],n=t[i+2];r<e.min[0]?e.min[0]=r:r>e.max[0]&&(e.max[0]=r),a<e.min[1]?e.min[1]=a:a>e.max[1]&&(e.max[1]=a),n<e.min[2]?e.min[2]=n:n>e.max[2]&&(e.max[2]=n)}return e.width=e.max[0]-e.min[0],e.height=e.max[1]-e.min[1],e.depth=e.max[2]-e.min[2],e.diameter=Math.max(e.width,e.height,e.depth),e},lookup_faces:function(t,e,i){for(var r=[],a=0;a<e.length;a++)for(var n=e[a]*i,s=0;s<i;s++)r.push(t[n+s]);return r},calculate_normals:function(t,e,i){for(var r=[],a={normals:[],addNormal:function(t,e){var i=this.normals[t]||(this.normals[t]=[0,0,0]);i[0]+=e[0],i[1]+=e[1],i[2]+=e[2]},getNormal:function(t){return this.normals[t]},normalize:function(){for(var t=0;t<this.normals.length;t++){var e=this.normals[t];if(e){var i=1/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]*=i,e[1]*=i,e[2]*=i}}}},n=0,s=0;n<t.length;n+=9,s+=3){var o=this.find_normal(t[n],t[n+1],t[n+2],t[n+3],t[n+4],t[n+5],t[n+6],t[n+7],t[n+8]);if(i)for(var h=0;h<3;h++)r.push(o[0]),r.push(o[1]),r.push(o[2]);else a.addNormal(e[s],o),a.addNormal(e[s+1],o),a.addNormal(e[s+2],o)}if(!i){a.normalize();for(n=0;n<e.length;n++){o=a.getNormal(e[n]);r.push(o[0]),r.push(o[1]),r.push(o[2])}}return r},find_normal:function(t,e,i,r,a,n,s,o,h){var l=vec3.create([t-r,e-a,i-n]),u=vec3.create([r-s,a-o,n-h]),c=vec3.create([s-t,o-e,h-i]),f=vec3.cross(l,u,vec3.create());return 0==vec3.lengthSquare(f)&&vec3.cross(u,c,f),0==vec3.lengthSquare(f)&&vec3.cross(c,l,f),0==vec3.lengthSquare(f)&&vec3.set([0,0,1],f),vec3.normalize(f)}};